<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day 1: 九州登陸與第一碗烏冬</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
        
        /* 地圖容器設定 */
        #map-container {
            height: 40vh; /* 手機版地圖佔螢幕高度 40% */
            width: 100%;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* 時間軸樣式 */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
            z-index: 0;
        }

        /* 卡片淡入動畫 */
        .fade-in-section {
            opacity: 0.5;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
            will-change: opacity, visibility;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: none;
        }
        .active-card {
            border-left-color: #EF4444; /* 紅色邊框表示目前位置 */
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <div id="map-container"></div>

    <div class="relative max-w-md mx-auto bg-white min-h-screen rounded-t-3xl -mt-6 z-40 shadow-inner px-6 py-8">
        
        <header class="mb-8 pl-4 border-l-4 border-red-500">
            <h1 class="text-2xl font-bold text-gray-900">Kyushu Trip Day 1</h1>
            <div class="flex items-center text-sm text-gray-500 mt-1 space-x-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                <span>2025.11.29</span>
                <span>•</span>
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                <span>福岡縣</span>
            </div>
        </header>

        <div class="relative pb-20" id="timeline-container">
            <div class="timeline-line"></div>
            </div>

        <footer class="text-center text-xs text-gray-400 py-10">
            Memory generated by My Travel App
        </footer>
    </div>

    <script src="data.js"></script>

    <script>
        // 初始化圖示
        lucide.createIcons();

        // --- 1. 初始化地圖 ---
        const map = L.map('map-container', { 
            zoomControl: false, // 手機版隱藏縮放按鈕比較清爽
            scrollWheelZoom: false // 防止滑動頁面時誤觸地圖縮放
        }).setView([33.5902, 130.4017], 10);
        
        // 使用 CartoDB 的清爽版地圖風格
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // 自訂 Marker 樣式
        const createIcon = (color) => L.divIcon({
            className: 'custom-div-icon',
            html: `<div style='background-color:${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color};'></div>`,
            iconSize: [14, 14],
            iconAnchor: [7, 7]
        });

        const defaultIcon = createIcon('#EF4444'); // 紅色
        const activeIcon = createIcon('#3B82F6');  // 藍色 (高亮用)

        // --- 2. 讀取資料並渲染 ---
        const timelineContainer = document.getElementById('timeline-container');
        const markers = {}; 
        const pathCoordinates = []; 

        if (typeof TRIP_MEMORY_DATA !== 'undefined' && TRIP_MEMORY_DATA.length > 0) {
            
            TRIP_MEMORY_DATA.forEach((item, index) => {
                // A. 建立地圖 Marker
                if (item.location && item.location.lat) {
                    const latlng = [item.location.lat, item.location.lng];
                    pathCoordinates.push(latlng);
                    
                    const marker = L.marker(latlng, {icon: defaultIcon}).addTo(map);
                    markers[index] = marker;
                }

                // B. 建立卡片 HTML
                const card = document.createElement('div');
                card.className = `timeline-item relative mb-12 pl-12 fade-in-section border-l-4 border-transparent transition-colors duration-300`;
                card.setAttribute('data-index', index);
                
                // 照片區塊
                const photoHtml = item.photo 
                    ? `<div class="mb-4 rounded-2xl overflow-hidden shadow-md aspect-[4/3] relative group">
                         <img src="${item.photo}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700" alt="${item.name}" loading="lazy">
                       </div>` 
                    : '';

                // 筆記區塊
                const noteHtml = item.note 
                    ? `<div class="bg-yellow-50 p-4 rounded-xl text-sm text-gray-700 leading-relaxed border border-yellow-100 relative shadow-sm">
                         <i data-lucide="quote" class="w-4 h-4 text-yellow-400 absolute top-2 left-2 opacity-50"></i>
                         <div class="pl-4 italic">"${item.note}"</div>
                       </div>`
                    : '';

                card.innerHTML = `
                    <div class="absolute left-[23px] top-1 w-4 h-4 rounded-full bg-white border-4 border-red-500 z-10 box-border transform -translate-x-1/2 shadow-sm"></div>
                    
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded-full shadow-sm tracking-wide">${item.time || 'Day 1'}</span>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-3 leading-tight">${item.name}</h3>
                    
                    ${photoHtml}
                    ${noteHtml}
                `;
                
                // 點擊卡片 -> 地圖飛過去
                card.addEventListener('click', () => {
                    const m = markers[index];
                    if (m) {
                        map.flyTo(m.getLatLng(), 15, { duration: 1.5 });
                    }
                });

                timelineContainer.appendChild(card);
            });

            // C. 畫出路徑線
            if (pathCoordinates.length > 1) {
                L.polyline(pathCoordinates, {
                    color: '#EF4444',
                    weight: 3,
                    opacity: 0.6,
                    dashArray: '5, 10',
                    lineCap: 'round'
                }).addTo(map);
            }

            // D. 自動調整地圖視野
            if (pathCoordinates.length > 0) {
                const bounds = L.latLngBounds(pathCoordinates);
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            }

        } else {
            timelineContainer.innerHTML = '<p class="pl-12 text-gray-400">沒有找到行程資料...</p>';
        }
        
        // 重新渲染圖示 (因為剛插入了 HTML)
        lucide.createIcons();

        // --- 3. 滾動連動地圖效果 ---
        const observerOptions = {
            root: null,
            rootMargin: '-40% 0px -40% 0px', // 讓判定線在螢幕中間
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    
                    const idx = entry.target.getAttribute('data-index');
                    if (markers[idx]) {
                        // 地圖移動
                        map.flyTo(markers[idx].getLatLng(), 15, { duration: 1.2 });
                        
                        // 視覺回饋：變更 Marker 顏色 (這裡簡化處理，實際可用 setIcon)
                        // document.querySelectorAll('.timeline-item').forEach(el => el.classList.remove('active-card'));
                        // entry.target.classList.add('active-card');
                    }
                }
            });
        }, observerOptions);

        document.querySelectorAll('.timeline-item').forEach((el) => {
            observer.observe(el);
        });

    </script>
</body>
</html>