<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>九州賞楓完整記錄</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        #map-container {
            height: 35vh; width: 100%; position: sticky; top: 0; z-index: 40;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .timeline-line {
            position: absolute; left: 24px; top: 20px; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0;
        }
        .fade-in-section { opacity: 0; transform: translateY(20px); transition: all 0.6s ease-out; }
        .fade-in-section.is-visible { opacity: 1; transform: none; }
        
        /* 導覽列樣式 */
        .day-nav-item.active { background-color: #EF4444; color: white; border-color: #EF4444; }
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <div id="map-container"></div>

    <div class="sticky top-[35vh] z-30 bg-white/95 backdrop-blur shadow-sm border-b overflow-x-auto scrollbar-hide">
        <div class="flex px-4 py-3 space-x-3" id="day-nav">
            </div>
    </div>

    <div class="relative max-w-md mx-auto min-h-screen -mt-2 z-20 px-4 pb-20" id="main-content">
        </div>

    <script src="data.js"></script>

    <script>
        lucide.createIcons();

        // --- 初始化地圖 ---
        const map = L.map('map-container', { zoomControl: false }).setView([33.5902, 130.4017], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        const markers = {}; 
        const allPathCoords = [];

        // 圖示樣式
        const createIcon = (color) => L.divIcon({
            className: 'custom-div-icon',
            html: `<div style='background-color:${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px ${color};'></div>`,
            iconSize: [14, 14], iconAnchor: [7, 7]
        });

        // --- 渲染內容 ---
        if (typeof TRIP_FULL_DATA !== 'undefined' && TRIP_FULL_DATA.length > 0) {
            const navContainer = document.getElementById('day-nav');
            const mainContainer = document.getElementById('main-content');
            
            TRIP_FULL_DATA.forEach((dayData, dIndex) => {
                // 1. 建立導覽按鈕
                const navBtn = document.createElement('button');
                navBtn.className = `day-nav-item flex-shrink-0 px-4 py-1.5 rounded-full border border-gray-200 text-sm font-bold text-gray-500 transition-colors`;
                navBtn.innerText = `Day ${dayData.day}`;
                navBtn.onclick = () => {
                    document.getElementById(`day-section-${dayData.day}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                navContainer.appendChild(navBtn);

                // 2. 建立該天的區塊
                const daySection = document.createElement('div');
                daySection.id = `day-section-${dayData.day}`;
                daySection.className = "pt-8 pb-4 scroll-mt-[40vh]"; // scroll-mt 確保滾動時不被地圖遮住
                
                // 天標題
                daySection.innerHTML = `
                    <div class="mb-6 pl-2 border-l-4 border-red-500">
                        <h2 class="text-2xl font-bold text-gray-900">${dayData.title}</h2>
                        <div class="text-sm text-gray-500 font-mono mt-1">${dayData.date}</div>
                    </div>
                    <div class="relative pl-4" id="timeline-${dayData.day}">
                        <div class="timeline-line"></div>
                    </div>
                `;
                mainContainer.appendChild(daySection);

                // 3. 建立該天的行程卡片
                const timelineContainer = daySection.querySelector(`#timeline-${dayData.day}`);
                
                dayData.timeline.forEach((item, idx) => {
                    const uniqueId = `${dayData.day}-${idx}`;
                    
                    // A. 地圖 Marker
                    if (item.location && item.location.lat) {
                        const latlng = [item.location.lat, item.location.lng];
                        allPathCoords.push(latlng);
                        const marker = L.marker(latlng, {icon: createIcon('#EF4444')}).addTo(map);
                        markers[uniqueId] = marker;
                    }

                    // B. 卡片 HTML
                    const card = document.createElement('div');
                    card.className = "timeline-item relative mb-12 pl-8 fade-in-section";
                    card.setAttribute('data-uid', uniqueId); // 用來連動地圖

                    // 照片
                    const photoHtml = item.photo ? 
                        `<div class="mb-3 rounded-xl overflow-hidden shadow-sm aspect-[4/3] relative">
                            <img src="${item.photo}" class="w-full h-full object-cover" loading="lazy">
                        </div>` : '';
                    
                    // 筆記
                    const noteHtml = item.note ? 
                        `<div class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-700 italic border border-yellow-100">
                            "${item.note}"
                        </div>` : '';

                    card.innerHTML = `
                        <div class="absolute left-[15px] top-1 w-4 h-4 rounded-full bg-white border-4 border-red-500 z-10 transform -translate-x-1/2"></div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold text-white bg-red-500 px-2 py-0.5 rounded-full">${item.time || '--:--'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${item.name}</h3>
                        ${photoHtml}
                        ${noteHtml}
                    `;
                    
                    card.addEventListener('click', () => {
                        if (markers[uniqueId]) map.flyTo(markers[uniqueId].getLatLng(), 15, { duration: 1 });
                    });
                    
                    timelineContainer.appendChild(card);
                });
            });

            // 畫出整趟路徑
            if (allPathCoords.length > 1) {
                L.polyline(allPathCoords, { color: '#EF4444', weight: 3, opacity: 0.6, dashArray: '5, 10' }).addTo(map);
                map.fitBounds(L.latLngBounds(allPathCoords), { padding: [50, 50] });
            }
        }

        // --- 滾動監聽 (Highlighter) ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    
                    // 地圖連動
                    const uid = entry.target.getAttribute('data-uid');
                    if (markers[uid]) map.flyTo(markers[uid].getLatLng(), 14, { duration: 1.5 });

                    // 導覽列連動 (簡易判斷: 找這張卡片屬於哪一天)
                    const daySection = entry.target.closest('[id^="day-section-"]');
                    if (daySection) {
                        const dayNum = daySection.id.split('-')[2];
                        document.querySelectorAll('.day-nav-item').forEach((btn, idx) => {
                            // 這裡假設按鈕順序 = Day 順序 (Day 1, Day 2...)
                            if ((idx + 1) == dayNum) btn.classList.add('active');
                            else btn.classList.remove('active');
                        });
                    }
                }
            });
        }, { rootMargin: '-40% 0px -40% 0px' });

        document.querySelectorAll('.timeline-item').forEach(el => observer.observe(el));

    </script>
</body>
</html>