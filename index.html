<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰πùÂ∑ûÂÖ´Êó•Ë≥ûÊ•ìË°åÊóÖ</title>
    
    <!-- PWA Ë®≠ÂÆö -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f8f5f2; -webkit-tap-highlight-color: transparent; }
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .recording-dot { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Ë®≠ÂÆöËàáÂ∑•ÂÖ∑ ---
        const DB_NAME = 'KyushuTripDB';
        const STORE_GPS = 'gps_logs';
        const STORE_PHOTOS = 'photos';
        const STORE_CUSTOM_SPOTS = 'custom_spots';

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);
                request.onerror = (event) => console.error("DB Error", event);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_GPS)) db.createObjectStore(STORE_GPS, { keyPath: 'timestamp' });
                    if (!db.objectStoreNames.contains(STORE_PHOTOS)) db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_CUSTOM_SPOTS)) db.createObjectStore(STORE_CUSTOM_SPOTS, { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = (event) => resolve(event.target.result);
            });
        };

        const dbOps = {
            saveGPS: async (lat, lng) => {
                const db = await initDB();
                db.transaction(STORE_GPS, 'readwrite').objectStore(STORE_GPS).add({ timestamp: Date.now(), lat, lng });
            },
            savePhoto: async (id, base64) => {
                const db = await initDB();
                db.transaction(STORE_PHOTOS, 'readwrite').objectStore(STORE_PHOTOS).put({ id, image: base64, timestamp: Date.now() });
            },
            getPhoto: async (id) => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_PHOTOS, 'readonly').objectStore(STORE_PHOTOS).get(id);
                    req.onsuccess = () => r(req.result?.image);
                });
            },
            addCustomSpot: async (spot) => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_CUSTOM_SPOTS, 'readwrite').objectStore(STORE_CUSTOM_SPOTS).add(spot);
                    req.onsuccess = () => r(true);
                });
            },
            getCustomSpots: async () => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_CUSTOM_SPOTS, 'readonly').objectStore(STORE_CUSTOM_SPOTS).getAll();
                    req.onsuccess = () => r(req.result || []);
                });
            }
        };

        const exportData = async () => {
            const db = await initDB();
            const getLogs = (store) => new Promise(r => {
                const req = db.transaction(store, 'readonly').objectStore(store).getAll();
                req.onsuccess = () => r(req.result);
            });
            const [gps, photos, customSpots] = await Promise.all([
                getLogs(STORE_GPS), getLogs(STORE_PHOTOS), getLogs(STORE_CUSTOM_SPOTS)
            ]);
            const expenses = JSON.parse(localStorage.getItem('trip_expenses') || '[]');
            const data = { gps, photos, customSpots, expenses, exportTime: new Date().toLocaleString() };
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `kyushu_trip_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c;
            return d < 1 ? `${Math.round(d * 1000)}m` : `${d.toFixed(1)}km`;
        };

        // --- ÂÆåÊï¥Ë°åÁ®ãË≥áÊñô (‰ΩøÁî® .jpg Ëàá Ë©≥Á¥∞ÊèèËø∞) ---
        const tripData = [
            {
                day: 1,
                date: "11/29 (‰∫î)",
                fullDate: "2024-11-29",
                title: "ÁßãÊúàÂè§ÂüéËàáÈäÄÊùè",
                weather: "Êô¥ÊôÇÂ§öÈõ≤ 15¬∞C",
                image: "./images/1.jpg",
                route: "ÁÜäÊú¨Ê©üÂ†¥ ‚Üí Â§™ÂéüÈäÄÊùè ‚Üí ÁßãÊúàÂüéË∑°",
                locations: [
                    { time: "10:00", name: "ÁÜäÊú¨Ê©üÂ†¥ (KMJ)", desc: "ÂèñËªäÂá∫Áôº", type: "transport", lat: 32.8372, lng: 130.8569 },
                    { 
                        time: "12:30", 
                        name: "Â§™ÂéüÈäÄÊùèÊ£ÆÊûó", 
                        desc: "ÁµïÁæéÈáëÈªÉÂú∞ÊØØ", 
                        type: "spot", 
                        tags: ["ÂøÖÊãç", "Â≠£ÁØÄÈôêÂÆö"], 
                        link: "https://www.google.com/maps/search/?api=1&query=Â§™ÂéüÈäÄÊùèÊ£ÆÊûó",
                        lat: 33.2725, lng: 130.6389,
                        details: "‰ΩçÊñºÂª£Â∑ùÁî∫ÁöÑÁßÅ‰∫∫ÈäÄÊùèÊûóÔºåÂè™ÊúâÂú®ÁßãÂ≠£Á¥ÖËëâÊúüÈñìÊâçÁâπÂà•Â∞çÂ§ñÈñãÊîæ„ÄÇÈÄôË£°Á®ÆÊ§ç‰∫ÜÁ¥Ñ80Ê£µ‰ΩéÁüÆÁöÑÈäÄÊùèÊ®πÔºåÂõ†ÁÇ∫Ê®πÈ´òËºÉ‰ΩéÔºåÈùûÂ∏∏ÈÅ©Âêà‰∫∫ÂÉèÊîùÂΩ±„ÄÇÁï∂ËêΩËëâÈã™ÊªøÂú∞Èù¢ÊôÇÔºåÂ∞±ÂÉèËµ∞Âú®‰∏ÄÊ¢ùÈáëÈªÉËâ≤ÁöÑÂú∞ÊØØ‰∏äÔºåÊòØËøëÂπ¥‰πùÂ∑ûIGÁàÜÁ¥ÖÁöÑÁßòÂ¢É„ÄÇ"
                    },
                    { 
                        time: "14:30", 
                        name: "Â§ßËààÂñÑÂØ∫", 
                        desc: "Á¥ÖËëâÈöéÊ¢ØÁµïÊôØ", 
                        type: "spot", 
                        tags: ["Á¥ÖËëâÂêçÊâÄ"], 
                        link: "https://www.google.com/maps/search/?api=1&query=Â§ßËààÂñÑÂØ∫",
                        lat: 33.4357, lng: 130.5367,
                        details: "ÊìÅÊúâ1300Âπ¥Ê≠∑Âè≤ÁöÑÂè§ËÄÅÂØ∫ÂªüÔºå‰ΩçÊñº‰ΩêË≥ÄËàáÁ¶èÂ≤°ÁöÑ‰∫§Áïå„ÄÇÂæûÂ±±ËÖ≥‰∏ãÁöÑÂÅúËªäÂ†¥Ê≤øËëóÂèÉÈÅìËµ∞‰∏äÂéªÔºåÊúÉÁ∂ìÈÅéËëóÂêçÁöÑ„Äå127ÊÆµÁü≥Èöé„ÄçÔºåÂÖ©ÊóÅÊ•ìÁ¥ÖÊé©Êò†ÔºåÊòØÊîùÂΩ±ÊÑõÂ•ΩËÄÖÁöÑÊúÄÊÑõ„ÄÇÂØ∫ÂæåÁöÑ„ÄåÂ•ëÂúí„ÄçÁ®ÆÊ§ç‰∫Ü500Â§öÊ£µÊ•ìÊ®πÔºåËàáËåÖËçâÂ±ãÈ†ÇÁöÑÊú¨Â†ÇÁõ∏Êò†ÊàêË∂£„ÄÇ"
                    },
                    { 
                        time: "16:30", 
                        name: "ÁßãÊúàÂüéË∑°", 
                        desc: "ÈªëÈñÄËàáÊ•ìËëâÁöÑÂ∞çÊØî", 
                        type: "spot", 
                        tags: ["Â∞è‰∫¨ÈÉΩ"], 
                        link: "https://www.google.com/maps/search/?api=1&query=ÁßãÊúàÂüéË∑°",
                        lat: 33.4667, lng: 130.6942,
                        details: "Ë¢´Á®±ÁÇ∫„ÄåÁ≠ëÂâçÁöÑÂ∞è‰∫¨ÈÉΩ„ÄçÔºå‰øùÁïô‰∫ÜÊ±üÊà∂ÊôÇ‰ª£ÁöÑÂüé‰∏ãÁî∫È¢®Ë≤å„ÄÇÂøÖÁúãÁöÑÊòØ„ÄåÈªëÈñÄ„ÄçÔºåÈÄôÂéüÊú¨ÊòØÁßãÊúàÂüéÁöÑÊ≠£ÈñÄÔºåÈªëËâ≤ÁöÑÊú®ÈÄ†Âª∫ÁØâÂú®Âë®ÂúçÁÅ´Á¥ÖÊ•ìËëâÁöÑË•ØÊâò‰∏ãÔºåÈ°ØÂæóÊ†ºÂ§ñËéäÂö¥ÁæéÈ∫ó„ÄÇÂª∫Ë≠∞ÂèØ‰ª•Âú®ÈôÑËøëÁöÑËå∂Â±ãÂìÅÂöêËëõÈ§Ö„ÄÇ" 
                    },
                ],
                hotel: { name: "Akizuki OKO art+inn", price: 33000, link: "https://www.google.com/maps/search/?api=1&query=Akizuki+OKO" }
            },
            {
                day: 2,
                date: "11/30 (ÂÖ≠)",
                fullDate: "2024-11-30",
                title: "Á¶èÂ≤°ÁπÅËèØÂ∑°Á¶Æ",
                weather: "Â§öÈõ≤ 14¬∞C",
                image: "./images/2.jpg",
                locations: [
                    { time: "11:30", name: "Â§©Á•ûÂú∞‰∏ãË°ó", desc: "Â•ΩÈÄõÂ•ΩË≤∑", type: "shop", tags: ["‰º¥ÊâãÁ¶Æ", "Ëó•Â¶ù"], link: "https://www.google.com/maps/search/?api=1&query=Â§©Á•ûÂú∞‰∏ãË°ó", lat: 33.5915, lng: 130.3989, details: "‰πùÂ∑ûÊúÄÂ§ßÁöÑÂú∞‰∏ãË≥ºÁâ©‰∏≠ÂøÉÔºåÂÖ®Èï∑Á¥Ñ600ÂÖ¨Â∞∫ÔºåÈ¢®Ê†ºÊ®°‰ªø19‰∏ñÁ¥ÄÊ≠êÊ¥≤Ë°óÈÅìÔºåÁü≥ÊùøÂú∞ËàáÈëÑÈêµË£ùÈ£æÈùûÂ∏∏ÊúâÊ∞£Ê∞õ„ÄÇÈÄ£Êé•‰∫ÜÂêÑÂ§ßÁôæË≤®ÂÖ¨Âè∏ËàáÂú∞ÈêµÁ´ôÔºåÈõÜÁµê‰∫ÜÊµÅË°åÊúçÈ£æ„ÄÅÈõúË≤®ËàáÂøÖË≤∑‰º¥ÊâãÁ¶ÆÔºàÂ¶ÇBake Cheese Tart„ÄÅÈà¥Êá∏Á≠âÔºâ„ÄÇ" },
                    { time: "13:30", name: "‰∏ÄËò≠ÊãâÈ∫µ Á∏ΩÊú¨Â∫ó", desc: "Á¶èÂ≤°ÈôêÂÆöÊñπÁ¢ó", type: "food", tags: ["ÂøÖÂêÉ", "ÊéíÈöä"], link: "https://www.google.com/maps/search/?api=1&query=‰∏ÄËò≠ÊãâÈ∫µÁ∏ΩÊú¨Â∫ó", lat: 33.5932, lng: 130.4046, details: "‰∏ÄËò≠ÊãâÈ∫µÁöÑÁ∏ΩÈÉ®Â§ßÊ®ìÔºåÂè™ÊúâÂú®ÈÄôË£°ÂèØ‰ª•Áî®„ÄåÊñπÁ¢óÔºàÈáçÁÆ±„Å©„Çì„Å∂„ÇäÔºâ„ÄçÂêÉÊãâÈ∫µÔºåÈùûÂ∏∏ÊúâÂÑÄÂºèÊÑü„ÄÇ‰∏ÄÊ®ìÊòØÂ±ãÂè∞È¢®Ê†ºÂ∫ß‰ΩçÔºå‰∫åÊ®ì‰ª•‰∏äÂâáÊòØÁ∂ìÂÖ∏ÁöÑÂë≥ÈõÜ‰∏≠Â∫ß‰Ωç„ÄÇ" },
                    { time: "18:00", name: "‰∏≠Ê¥≤Â±ãÂè∞", desc: "È´îÈ©óÂú®Âú∞Â§úÁîüÊ¥ª", type: "food", tags: ["ÈóúÊù±ÁÖÆ", "ÊòéÂ§™Â≠ê"], link: "https://www.google.com/maps/search/?api=1&query=‰∏≠Ê¥≤Â±ãÂè∞Ê©´‰∏Å", lat: 33.5923, lng: 130.4069, details: "ÈÇ£ÁèÇÂ∑ùÊ≤øÂ≤∏ÊûóÁ´ãÁöÑÂ±ãÂè∞Ë°óÊòØÁ¶èÂ≤°ÁöÑÂ§úÊôöË±°Âæµ„ÄÇÂª∫Ë≠∞Èªû‰∏Ä‰ªΩÂçöÂ§öËëóÂêçÁöÑ„ÄåÊòéÂ§™Â≠êÁéâÂ≠êÁáí„ÄçÈÖç‰∏äÂï§ÈÖí„ÄÇÂ¶ÇÊûú‰∏çÁøíÊÖ£Ë∑ØÈÇäÊî§Ôºå‰πüÂèØ‰ª•ÂéªÈÅãÊ≤≥ÂüéÈôÑËøëÁöÑÈ§êÂª≥„ÄÇ" },
                ],
                hotel: { name: "ÂçöÂ§ö RESOL TRINITY", price: 50000, link: "https://www.google.com/maps/search/?api=1&query=Hotel+Resol+Trinity+Hakata" }
            },
            {
                day: 3,
                date: "12/01 (Êó•)",
                fullDate: "2024-12-01",
                title: "ËÄ∂È¶¨Ê∫™ËàáÂà•Â∫ú",
                weather: "Êô¥Â§© 12¬∞C",
                image: "./images/3.jpg",
                locations: [
                    { time: "11:30", name: "Ê∑±ËÄ∂È¶¨Ê∫™", desc: "‰∏ÄÁõÆÂÖ´ÊôØÔºåÂ•áÂ≤©ËàáÁ¥ÖËëâ", type: "spot", tags: ["ÁµïÊôØ"], link: "https://www.google.com/maps/search/?api=1&query=Ê∑±ËÄ∂È¶¨Ê∫™‰∏ÄÁõÆÂÖ´ÊôØ", lat: 33.3725, lng: 131.0664, details: "ËÄ∂È¶¨Ê∫™ÊòØ‰πùÂ∑ûÊúÄËëóÂêçÁöÑÁ¥ÖËëâÂ≥ΩË∞∑ÔºåÂÖ∂‰∏≠„Äå‰∏ÄÁõÆÂÖ´ÊôØ„ÄçÊòØÊúÄÁ≤æËèØÁöÑÂ±ïÊúõÂè∞ÔºåÁ´ôÂú®ÈÄôË£°ÂèØ‰ª•‰∏ÄÁúºÊúõÁõ°Âë®ÂúçÂÖ´Â∫ßÂ•áÂΩ¢ÊÄ™ÁãÄÁöÑÂ≤©Â≥∞ÔºàÂ¶ÇÁæ§ÁåøÂ±±„ÄÅ‰ªô‰∫∫Â≤©Á≠âÔºâ„ÄÇÁßãÂ≠£ÊôÇÔºåÁÅ∞ÁôΩÁöÑÂ≤©Áü≥ËàáÁÅ´Á¥ÖÁöÑÊ•ìËëâÂΩ¢ÊàêÂº∑ÁÉàÂ∞çÊØîÔºåÊôØËâ≤Â£ØÈ∫ó„ÄÇ" },
                    { time: "14:00", name: "ÂØåË≤¥ÂØ∫", desc: "ÂúãÂØ∂Â§ßÂ†Ç", type: "spot", tags: ["Âè§Ââé"], link: "https://www.google.com/maps/search/?api=1&query=ÂØåË≤¥ÂØ∫", lat: 33.5414, lng: 131.5283, details: "‰πùÂ∑ûÁèæÂ≠òÊúÄÂè§ËÄÅÁöÑÊú®ÈÄ†Âª∫ÁØâ‰πã‰∏ÄÔºåÂÖ∂„ÄåÂ§ßÂ†Ç„ÄçË¢´ÊåáÂÆöÁÇ∫Êó•Êú¨ÂúãÂØ∂„ÄÇÂª∫ÁØâÈ¢®Ê†ºÁ∞°Ê®∏ËéäÂö¥ÔºåÁßãÂ≠£ÊôÇÂ§ßÂ†ÇÂë®ÂúçÊúÉË¢´Â∑®Â§ßÁöÑÈäÄÊùèÊ®πËàáÊ•ìËëâÂåÖÂúçÔºåÈáëÈªÉËàáÊú±Á¥ÖËêΩËëâÈã™ÊªøÂ∫≠Èô¢ÔºåÂëàÁèæÂá∫Ê•µÂÖ∑Á¶™ÊÑèÁöÑÂπ≥ÂÆâÊôÇ‰ª£ÁæéÂ≠∏„ÄÇ" },
                    { time: "17:00", name: "Âà•Â∫úÊ∫´Ê≥â", desc: "Âú∞ÁçÑËí∏ÊñôÁêÜÊôöÈ§ê", type: "relax", tags: ["Ê∫´Ê≥â"], link: "https://www.google.com/maps/search/?api=1&query=Âà•Â∫úÊ∫´Ê≥â", lat: 33.2800, lng: 131.5000, details: "Êó•Êú¨ÊπßÊ≥âÈáèÁ¨¨‰∏ÄÁöÑÊ∫´Ê≥âÂú∞ÔºåÊï¥ÂÄãÂüéÂ∏ÇÈö®ËôïÂèØË¶ãÊ∫´Ê≥âËí∏Ê∞£ÔºàÊπØÁÖôÔºâÂÜíÂá∫„ÄÇÈô§‰∫ÜËëóÂêçÁöÑÂú∞ÁçÑÂ∑°Á¶ÆÔºåÈÄôË£°ÁöÑÊ∫´Ê≥âÊ≥âË≥™Â§öÊ®£„ÄÇÊÇ®ÂÖ•‰ΩèÁöÑÊµ∑ÊôØÊ∫´Ê≥âÂèØ‰ª•‰∏ÄÈÇäÊ≥°ÊπØ‰∏ÄÈÇäÁú∫ÊúõÂà•Â∫úÁÅ£ÔºåÊòØÊ∂àÈô§Èï∑ÈÄîÈßïÈßõÁñ≤ÂãûÁöÑÊúÄ‰Ω≥‰∫´Âèó„ÄÇ"},
                ],
                hotel: { name: "Âà•Â∫ú Airbnb", price: 23000, link: "" }
            },
            {
                day: 4,
                date: "12/02 (‰∏Ä)",
                fullDate: "2024-12-02",
                title: "Áî±Â∏ÉÈô¢Á´•Ë©±Êï£Á≠ñ",
                weather: "Èô∞ÊôÇÂ§öÈõ≤ 11¬∞C",
                image: "./images/4.jpg",
                locations: [
                    { time: "11:00", name: "Âà•Â∫úÊµ∑ÈÆÆÂ∏ÇÂ†¥", desc: "ÂçàÈ§êÂêÉÊñ∞ÈÆÆÊµ∑ÈÆÆ", type: "food", tags: ["Êµ∑ÈÆÆ‰∏º"], link: "", lat: 33.3000, lng: 131.5000, details: "‰ΩçÊñºÂà•Â∫úÁÅ£ÊóÅÔºåÊèê‰æõÊúÄÊñ∞ÈÆÆÁöÑË±êÂæåÊ∞¥ÈÅìÊµ∑Áî¢„ÄÇÊé®Ëñ¶ÂìÅÂöêÂ§ßÂàÜÁ∏£ÁâπÁî¢„ÄåÈóúÈØñÈ≠ö„ÄçËàá„ÄåÈóúÁ´πËé¢È≠ö„ÄçÔºåËÇâË≥™Á∑äÂØ¶ÈÆÆÁîú„ÄÇ‰πüÂèØ‰ª•ÈÅ∏ÊìáÊµ∑ÈÆÆÁáíÁÉ§ÊàñË±™ÈÇÅÁöÑÊµ∑ÈÆÆ‰∏ºÈ£Ø‰ΩúÁÇ∫ÂçàÈ§ê„ÄÇ" },
                    { time: "14:30", name: "ÊπØ‰πãÂù™Ë°óÈÅì", desc: "Âè≤Âä™ÊØîËå∂Â±ã„ÄÅÁ´•Ë©±Êùë", type: "walk", tags: ["Â•ΩÈÄõ"], link: "https://www.google.com/maps/search/?api=1&query=ÊπØ‰πãÂù™Ë°óÈÅì", lat: 33.2667, lng: 131.3583, details: "ÈÄ£Êé•Áî±Â∏ÉÈô¢ËªäÁ´ôËàáÈáëÈ±óÊπñÁöÑ‰∏ªË¶ÅË°óÈÅìÔºåÂÖ©ÊóÅÊûóÁ´ãËëóÂêÑÂºèÁâπËâ≤Â∞èÂ∫ó„ÄÅÈõúË≤®ËàñËàáÁîúÈªûÂ∫ó„ÄÇÂøÖË®™ÁöÑ„ÄåYufuin Floral Village„ÄçÊòØ‰ªøÁÖßËã±ÂúãÁßëËå®Ê≤ÉÁàæÂæ∑ÊâìÈÄ†ÁöÑÁ´•Ë©±ÊùëÔºåÂÖÖÊªøÂìàÂà©Ê≥¢ÁâπËà¨ÁöÑÊ∞õÂúçÔºåÈùûÂ∏∏ÈÅ©ÂêàÊãçÁÖß„ÄÇ" },
                    { time: "15:00", name: "Milch Ëµ∑Âè∏ËõãÁ≥ï", desc: "ÂøÖÂêÉÁÜ±Ëµ∑Âè∏ËõãÁ≥ï", type: "food", tags: ["ÂøÖÂêÉÁîúÈªû"], link: "https://www.google.com/maps/search/?api=1&query=MilchÁî±Â∏ÉÈô¢", lat: 33.2650, lng: 131.3570, details: "ÊõæÁç≤Âæó‰∏ñÁïåÈáëË≥ûÁöÑÁîúÈªûÂêçÂ∫ó„ÄÇÊãõÁâå„ÄåKase Kuchen„ÄçÂçäÁÜüËµ∑Âè∏ËõãÁ≥ïÔºåÊúâÁÜ±ÂêÉËàáÂÜ∑ÂêÉÂÖ©Á®ÆÂè£ÊÑü„ÄÇÊé®Ëñ¶ÂòóË©¶ÁÜ±ÁöÑÔºåÁî®ÊπØÂåôÊåñ‰∏ãÂéªÔºå‰∏≠ÈñìÊøÉÈÉÅÁöÑËµ∑Âè∏ÂÖßÈ§°ÊúÉÁ∑©Á∑©ÊµÅÂá∫ÔºåÂ•∂È¶ôÊøÉÈÉÅ‰∏î‰∏çËÜ©Âè£„ÄÇ" },
                    { time: "16:00", name: "ÈáëÈ∫üÊπñ", desc: "Êπñ‰∏äÈ≥•Â±Ö", type: "spot", tags: ["ÊãçÁÖß"], link: "https://www.google.com/maps/search/?api=1&query=ÈáëÈ∫üÊπñ", lat: 33.2625, lng: 131.3620, details: "Áî±Â∏ÉÈô¢ÁöÑË±°ÂæµÔºåÊπñÂ∫ïÂêåÊôÇÊπßÂá∫Ê∫´Ê≥âËàáÊ∏ÖÊ∞¥ÔºåÂõ†Ê≠§Âú®ÁßãÂÜ¨ÁöÑÊ∏ÖÊô®ÔºåÊπñÈù¢ÊúÉÂõ†ÁÇ∫Ê∫´Â∑ÆÈ£ÑÊï£ËëóÂ§¢ÂπªÁöÑÁôΩËâ≤Êô®ÈúßÔºàÊúùÈúßÔºâ„ÄÇÊπñÁïîÁöÑ„ÄåÂ§©Á•ñÁ•ûÁ§æ„ÄçÊ∞¥‰∏äÈ≥•Â±ÖËàáÊ•ìËëâÂÄíÂΩ±ÔºåÊòØÊó©Ëµ∑Êï£Ê≠•ÊâçËÉΩÁúãÂà∞ÁöÑÁµïÊôØ„ÄÇ"},
                ],
                hotel: { name: "Áî±Â∏ÉÈô¢ Airbnb", price: 40200, link: "" }
            },
            {
                day: 5,
                date: "12/03 (‰∫å)",
                fullDate: "2024-12-03",
                title: "ÈªëÂ∑ùÊ∫´Ê≥âÁßòÂ¢É",
                weather: "Èõ®ÂæåËΩâÊô¥ 9¬∞C",
                image: "./images/5.jpg",
                locations: [
                    { time: "09:00", name: "B-speak", desc: "ÊéíÈöäË≤∑Áîü‰π≥Êç≤", type: "food", tags: ["ÈôêÈáè"], link: "https://www.google.com/maps/search/?api=1&query=B-speak", lat: 33.2645, lng: 131.3550, details: "Áî±Â∏ÉÈô¢Ê∫´Ê≥âÊóÖÈ§®„ÄåÂ±±Ëéä ÁÑ°ÈáèÂ°î„ÄçÈñãË®≠ÁöÑËõãÁ≥ïÊç≤Â∞àË≥£Â∫ó„ÄÇÂ†ÖÊåÅ‰∏çÊ∑ªÂä†‰∫∫Â∑•È¶ôÊñôÔºåÊµ∑Á∂øËõãÁ≥ïËì¨È¨ÜÊøïÊΩ§ÔºåÈÆÆÂ•∂Ê≤πÁîúÂ∫¶ÈÅ©‰∏≠‰∏îÊ∏ÖÁàΩ„ÄÇÂõ†ÁÇ∫ÈùûÂ∏∏Êê∂ÊâãÔºåÈÄöÂ∏∏Âª∫Ë≠∞ÈñãÂ∫óÂâçÂ∞±ÂéªÊéíÈöäÔºåÊàñË≥ºË≤∑ÂàáÁâáË£ùÂú®Ëªä‰∏ä‰∫´Áî®„ÄÇ" },
                    { time: "12:30", name: "Èçã„É∂Êªù ÁÄëÂ∏É", desc: "ÂèØÈÄ≤ÂÖ•ÂÖßÈÉ®ÁöÑÁÄëÂ∏É", type: "spot", tags: ["ÁßòÂ¢É"], link: "https://www.google.com/maps/search/?api=1&query=Èçã„É∂Êªù", lat: 33.1167, lng: 131.0250, details: "Âõ†Ëå∂È£≤Âª£ÂëäËÄåËÅ≤ÂêçÂ§ßÂô™ÁöÑÊôØÈªû„ÄÇÊúÄÂ§ßÁöÑÁâπËâ≤ÊòØÂèØ‰ª•Ëµ∞Âà∞ÁÄëÂ∏ÉÁöÑ„ÄåËÉåÈù¢„ÄçÔºåÂæûÊ∞¥Á∞æÂæåÊñπÂæÄÂ§ñÁúãÔºåÈôΩÂÖâÁ©øÈÄèÊ∞¥Áè†ËàáÊ®πÊûóÁöÑÊôØËâ≤ÈùûÂ∏∏Â§¢Âπª„ÄÇÁÄëÂ∏ÉÂØ¨Á¥Ñ20ÂÖ¨Â∞∫ÔºåËêΩÂ∑Æ‰∏çÂ§ß‰ΩÜÂßøÊÖãÂÑ™ÈõÖ„ÄÇ" },
                    { time: "14:30", name: "ÈªëÂ∑ùÊ∫´Ê≥â", desc: "Ë≥ºË≤∑ÂÖ•ÊπØÊâãÂΩ¢Ê≥°ÊπØ", type: "relax", tags: ["Á±≥ÂÖ∂Êûó‰∫åÊòü"], link: "https://www.google.com/maps/search/?api=1&query=ÈªëÂ∑ùÊ∫´Ê≥â", lat: 33.0783, lng: 131.1394, details: "Ë¢´Á±≥ÂÖ∂ÊûóÁ∂†Ëâ≤ÊåáÂçóË©ïÁÇ∫‰∫åÊòüÁöÑÊ∫´Ê≥âÂú∞„ÄÇÈÄôË£°ÁÇ∫‰∫ÜÁ∂≠Ë≠∑ÊôØËßÄÔºåÂÖ®ÂçÄÂª∫ÁØâÈ¢®Ê†ºÁµ±‰∏ÄÔºåÂÖÖÊªøÊøÉÂéöÁöÑÊ±üÊà∂Ëâ≤ÂΩ©„ÄÇÂà©Áî®„ÄåÂÖ•ÊπØÊâãÂΩ¢„ÄçÂèØ‰ª•‰ªªÈÅ∏‰∏âÂÆ∂ÊóÖÈ§®ÁöÑÈú≤Â§©Ê∫´Ê≥âÈ´îÈ©ó„ÄÇÊé®Ëñ¶ÂìÅÂöêÊ∫´Ê≥âË°ó‰∏äÁöÑ„ÄåPatisserie Roku„ÄçÁîü‰π≥Ê≥°ËäôÔºåÂ§ñÁöÆÈÖ•ËÑÜÂÖßÈ§°È£ΩÊªø„ÄÇ" },
                ],
                hotel: { name: "Â±±„Åø„ÅöÊú®", price: 105600, link: "https://www.google.com/maps/search/?api=1&query=Â±±„Åø„ÅöÊú®" }
            },
            {
                day: 6,
                date: "12/04 (‰∏â)",
                fullDate: "2024-12-04",
                title: "ÈòøËòáÁÅ´Â±±ËàáÁ•ûË©±",
                weather: "Êô¥Êúó 8¬∞C",
                image: "./images/6.jpg",
                locations: [
                    { time: "12:30", name: "ÈòøËòáÂ§ßËßÄÂ≥∞", desc: "Áú∫ÊúõÊ∂ÖÊßÉÂÉè", type: "spot", tags: ["Â£ØËßÄ"], link: "https://www.google.com/maps/search/?api=1&query=ÈòøËòáÂ§ßËßÄÂ≥∞", lat: 33.0333, lng: 131.0833, details: "‰ΩçÊñº‰πùÈáçÈÄ£Â±±ËàáÈòøËòáÂ±±‰πãÈñìÁöÑÈ´òÂéüÁîúÈªûÂ∫ó„ÄÇÂ∫óÂÖßÊãõÁâåÊòØÂπ¥Ëº™ËõãÁ≥ïËàáÁëûÂ£´Êç≤„ÄÇÊúÄÊ£íÁöÑÊòØÂèØ‰ª•Âú®Èú≤Âè∞Â∫ß‰ΩçÂçÄÔºå‰∏ÄÈÇä‰∫´Áî®Á≤æÁ∑ªÁîúÈªûÔºå‰∏ÄÈÇäÁú∫ÊúõÈòøËòá‰∫îÂ≤≥ÁöÑÂ£ØÈóäÂÖ®ÊôØÔºåÊòØËá™ÈßïÈÄî‰∏≠ÁöÑÊúÄ‰Ω≥‰ºëÊÅØÁ´ô„ÄÇ" },
                    { time: "13:30", name: "ËçâÂçÉÈáå", desc: "È®éÈ¶¨È´îÈ©ó", type: "spot", tags: [], link: "https://www.google.com/maps/search/?api=1&query=ËçâÂçÉÈáå", lat: 32.8842, lng: 131.0514, details: "‰ΩçÊñºÁÉèÂ∏ΩÂ≠êÂ≤≥ÂåóÈ∫ìÁöÑ‰∏ÄÁâáÂ∑®Â§ßÂúìÂΩ¢ËçâÂéüÔºåÂéüÊú¨ÊòØÁÅ´Â±±Âè£ÈÅ∫Ë∑°„ÄÇ‰∏≠Â§ÆÊúâÂÖ©ÂÄãÈõ®Ê∞¥ÂΩ¢ÊàêÁöÑÊ±†Â°òÔºåÂèØ‰ª•Ê∏ÖÊ•öÁúãÂà∞‰ªçÂú®ÂÜíÁÖôÁöÑ‰∏≠Â≤≥ÁÅ´Â±±Âè£„ÄÇÈÄôË£°ÂèØ‰ª•È´îÈ©óÈ®éÈ¶¨Êï£Ê≠•ÔºåÊôØËâ≤ÈñãÈóäÂ£ØÈ∫óÔºåÊòØÈòøËòáÊúÄÂÖ∑‰ª£Ë°®ÊÄßÁöÑÊôØÈªû„ÄÇ" },
                    { time: "16:00", name: "È´òÂçÉÁ©óÁ•ûÁ§æ", desc: "Â§úÁ•ûÊ®Ç", type: "spot", tags: ["Á•ûË©±"], link: "https://www.google.com/maps/search/?api=1&query=È´òÂçÉÁ©óÁ•ûÁ§æ", lat: 32.7100, lng: 131.3000, details: "Á¥Ñ1900Âπ¥ÂâçÂâµÂª∫ÁöÑÂè§ËÄÅÁ•ûÁ§æÔºåÊòØÈ´òÂçÉÁ©óÈÑâÂÖ´ÂçÅÂÖ´Á§æÁöÑÁ∏ΩÁ§æ„ÄÇÂ¢ÉÂÖßÊúâÊ®πÈΩ°Ë∂ÖÈÅé800Âπ¥ÁöÑ„ÄåÁß©Áà∂Êùâ„ÄçËàáÂÖ©Ê£µÊ†πÈÉ®Áõ∏ÈÄ£ÁöÑ„ÄåÂ§´Â©¶Êùâ„ÄçÔºåÊìöË™™ÁâΩÊâãÁπûË°å‰∏âÂúàËÉΩ‰øù‰ΩëÂßªÁ∑£ÁæéÊªø„ÄÇÊØèÊôöÈÄôË£°‰πüÊúÉËàâËæ¶ÊºîÁππÁ•ûË©±ÊïÖ‰∫ãÁöÑ„ÄåÂ§úÁ•ûÊ®Ç„Äç„ÄÇ" },
                ],
                hotel: { name: "Hotel Takachiho", price: 65600, link: "https://www.google.com/maps/search/?api=1&query=Hotel+Takachiho" }
            },
            {
                day: 7,
                date: "12/05 (Âõõ)",
                fullDate: "2024-12-05",
                title: "È´òÂçÉÁ©óÂàíËàπ",
                weather: "Â§öÈõ≤ 10¬∞C",
                image: "./images/7.jpg",
                locations: [
                    { time: "09:00", name: "È´òÂçÉÁ©óÂ≥Ω", desc: "Â≥ΩË∞∑ÂàíËàπ (Ë®òÂæóÈ†êÁ¥Ñ)", type: "spot", tags: ["ÂøÖÂéª", "È†êÁ¥Ñ"], link: "https://www.google.com/maps/search/?api=1&query=È´òÂçÉÁ©óÂ≥Ω", lat: 32.7050, lng: 131.3000, details: "Áî±ÈòøËòáÁÅ´Â±±Âô¥ÁôºÁöÑÁÜîÂ≤©ÊÄ•ÈÅΩÂÜ∑ÂçªÂæåÂΩ¢ÊàêÁöÑÊü±ÁãÄÁØÄÁêÜÂ≥ΩË∞∑„ÄÇÊúÄÁ∂ìÂÖ∏ÁöÑÁé©Ê≥ïÊòØÂàíËàπËøëË∑ùÈõ¢ËßÄË≥û„ÄåÁúüÂêç‰∫ïÁÄëÂ∏É„ÄçÔºåÁÄëÂ∏ÉÂæû17ÂÖ¨Â∞∫È´òÁöÑÂ≥≠Â£ÅÂÇæÁÄâËÄå‰∏ãÔºåÊ∞¥Ê∞£ËàáÂÖâÂΩ±‰∫§ÈåØÔºåÂÆõÂ¶ÇÈÄ≤ÂÖ•Á•ûË©±‰∏ñÁïå„ÄÇ" },
                    { time: "12:00", name: "È´òÂçÉÁ©óÁâõÁáíËÇâ Âíå", desc: "È†ÇÁ¥öÂíåÁâõÂçàÈ§ê", type: "food", tags: ["ÂøÖÂêÉ"], link: "https://www.google.com/maps/search/?api=1&query=È´òÂçÉÁ©óÁâõÁáíËÇâÂíå", lat: 32.7100, lng: 131.3050, details: "ÊõæÁç≤Âæó„ÄåÊó•Êú¨‰∏Ä„ÄçÊÆäÊ¶ÆÁöÑÈ´òÂçÉÁ©óÁâõÔºå‰ª•ËÑÇËÇ™ÂàÜÂ∏ÉÂùáÂãª„ÄÅÂè£ÊÑü‰∏çÊ≤πËÜ©ËëóÁ®±„ÄÇÈÄôÂÆ∂È§êÂª≥ÊòØJAÔºàËæ≤ÊúÉÔºâÁõ¥ÁáüÔºåËÉΩ‰ª•Áõ∏Â∞çÂØ¶ÊÉ†ÁöÑÂÉπÊ†ºÂêÉÂà∞ÊúÄÈ´òÂìÅË≥™ÁöÑÁâõËÇâ„ÄÇÂçàÈ§êÊôÇÊÆµÁöÑÁâõÊéíÂ•óÈ§êCPÂÄºÈùûÂ∏∏È´ò„ÄÇ" },
                    {
                        time: "15:30",
                        name: "Ê∞¥ÂâçÂØ∫ÊàêË∂£Âúí",
                        desc: "Á∏ÆÂ∞èÁâàÁöÑÊù±Êµ∑ÈÅì‰∫îÂçÅ‰∏âÊ¨°",
                        type: "spot",
                        tags: ["Â∫≠Âúí", "Êï£Ê≠•"],
                        link: "https://www.google.com/maps/search/?api=1&query=Ê∞¥ÂâçÂØ∫ÊàêË∂£Âúí",
                        lat: 32.7900, lng: 130.7300,
                        details: "ÁÜäÊú¨Ëó©‰∏ªÁ¥∞Â∑ùÂÆ∂Ê≠∑Á∂ì‰∏â‰ª£Âª∫ÈÄ†ÁöÑÊ°ÉÂ±±ÂºèËø¥ÈÅäÂ∫≠Âúí„ÄÇÂ∫≠ÂúíË®≠Ë®àÊ®°‰ªø‰∫ÜÊù±Êµ∑ÈÅì‰∫îÂçÅ‰∏âÊ¨°ÁöÑÊôØËâ≤ÔºåÂÖ∂‰∏≠ÊúÄËëóÂêçÁöÑÂ∞±ÊòØÊ®°‰ªø„ÄåÂØåÂ£´Â±±„ÄçÁöÑÂÅáÂ±±„ÄÇÊ±†Ê∞¥ÂºïËá™ÈòøËòá‰ºèÊµÅÊ∞¥ÔºåÊ∏ÖÊæàË¶ãÂ∫ï„ÄÇÁßãÂ≠£ÊôÇÂ∫≠ÂúíÂÖßÁöÑÊ•ìÊ®πËàáÊùæÊ®πÁõ∏‰∫íËºùÊò†ÔºåÊôØËâ≤ÂÑ™ÈõÖ„ÄÇ"
                    },
                    {
                        time: "16:30",
                        name: "Êµ∑Ë≥äÁéãÈ≠ØÂ§´ÈõïÂÉè",
                        desc: "Ëà™Êµ∑ÁéãÁ≤âÁµ≤ËÅñÂú∞",
                        type: "spot",
                        tags: ["ÂãïÊº´", "ÈäÄÊùè"],
                        link: "https://www.google.com/maps/search/?api=1&query=ÁÜäÊú¨Á∏£Âª≥+È≠ØÂ§´ÂÉè",
                        lat: 32.7950, lng: 130.7400,
                        details: "‰ΩçÊñºÁÜäÊú¨Á∏£Âª≥Êï£Ê≠•ÈÅì‰∏äÔºåÊòØÁÇ∫‰∫ÜÊÑüË¨ù‰ΩúËÄÖÂ∞æÁî∞Ê¶Æ‰∏ÄÈÉéÂ∞çÁÜäÊú¨Âú∞ÈúáÂæ©ËààÁöÑË≤¢ÁçªËÄåË®≠Á´ã„ÄÇÈÄôÂ∞äÈ≠ØÂ§´ÈäÖÂÉèÈÇÑÂéüÂ∫¶Ê•µÈ´ò„ÄÇÁßãÂ≠£ÈÄ†Ë®™ÊôÇÔºåÁ∏£Âª≥ÂâçÁöÑÂÖ©ÊéíÈäÄÊùèÂ§ßÈÅìÊúÉËÆäÊàêÈáëÈªÉËâ≤ÔºåÂâõÂ•ΩÊàêÁÇ∫È≠ØÂ§´Ë∫´ÂæåÊúÄÂ£ØËßÄÁöÑËÉåÊôØ„ÄÇ"
                    }
                ],
                hotel: { name: "‰∏â‰∫ïËä±ÂúíÈ£ØÂ∫ó ÁÜäÊú¨", price: 38000, link: "https://www.google.com/maps/search/?api=1&query=‰∏â‰∫ïËä±ÂúíÈ£ØÂ∫óÁÜäÊú¨" }
            },
             {
                day: 8,
                date: "12/06 (‰∫î)",
                fullDate: "2024-12-06",
                title: "ËøîÂè∞",
                weather: "Êô¥ 16¬∞C",
                image: "./images/8.jpg",
                locations: [
                    { time: "11:30", name: "ÁÜäÊú¨Ê©üÂ†¥", desc: "ÈÇÑËªä„ÄÅÊúÄÂæåÊé°Ë≤∑", type: "transport", tags: [], link: "https://www.google.com/maps/search/?api=1&query=ÁÜäÊú¨Ê©üÂ†¥", lat: 32.8372, lng: 130.8569 },
                ],
                hotel: null
            }
        ];

        // --- ÁµÑ‰ª∂ ---
        const Icon = ({ name, size = 18, className }) => {
            // ‰ΩøÁî® ref Á¢∫‰øùÂúñÁ§∫Ë¢´Ê∏≤Êüì
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        root: iconRef.current.parentNode,
                        nameAttr: 'data-lucide',
                        attrs: {
                            class: className,
                            style: `width: ${size}px; height: ${size}px;`
                        }
                    });
                }
            }, [name, size, className]);

            return <i ref={iconRef} data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const Tag = ({ text }) => <span className={`text-[10px] px-2 py-1 rounded-full font-bold mr-1 bg-gray-100 text-gray-600`}>{text}</span>;

        // Ë®òÂ∏≥ Modal (‰øÆÊ≠£Êó•ÊúüÈÇèËºØ)
        const ExpenseModal = ({ isOpen, onClose, defaultName, defaultDate }) => {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('food');

            useEffect(() => { 
                if(isOpen && defaultName) setName(defaultName); 
            }, [isOpen, defaultName]);

            const handleSave = () => {
                const dateToUse = defaultDate || new Date().toLocaleDateString();
                const newItem = { 
                    id: Date.now(), 
                    name, 
                    amount: parseInt(amount), 
                    category: cat, 
                    date: dateToUse, 
                    location: defaultName 
                };
                const saved = JSON.parse(localStorage.getItem('trip_expenses') || '[]');
                localStorage.setItem('trip_expenses', JSON.stringify([newItem, ...saved]));
                onClose();
                alert(`Â∑≤Ë®òÈåÑÊñº ${dateToUse}Ôºö${name} ¬•${amount}`);
                setName(''); setAmount('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center sm:items-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-md p-5 rounded-t-3xl sm:rounded-2xl modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="wallet" /> Ë®òÂ∏≥ {defaultDate && <span className="text-sm font-normal text-gray-500">({defaultDate})</span>}
                            </h3>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        <input type="text" placeholder="È†ÖÁõÆ" value={name} onChange={e => setName(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-3 text-lg font-bold" />
                        <input type="number" placeholder="¬• ÈáëÈ°ç" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-4 text-lg font-mono" autoFocus />
                        <div className="flex gap-2 mb-6">
                            {['food','transport','shop','other'].map(c => (
                                <button key={c} onClick={() => setCat(c)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${cat===c ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-400'}`}>
                                    {c==='food'?'È§êÈ£≤':c==='transport'?'‰∫§ÈÄö':c==='shop'?'Ë≥ºÁâ©':'ÂÖ∂‰ªñ'}
                                </button>
                            ))}
                        </div>
                        <button onClick={handleSave} disabled={!name || !amount} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg disabled:opacity-50">Á¢∫Ë™çÂÑ≤Â≠ò</button>
                    </div>
                </div>
            );
        };

        // Êñ∞Â¢ûÊôØÈªû Modal (È°ØÁ§∫Êó•ÊúüÊèêÁ§∫)
        const AddSpotModal = ({ isOpen, onClose, dayIndex, dayDate, userLocation, onAdded }) => {
            const [name, setName] = useState('');
            const [time, setTime] = useState(() => {
                const now = new Date();
                return `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            });

            const handleSave = async () => {
                if (!name) return;
                await dbOps.addCustomSpot({
                    name, time, type: 'custom', desc: 'ÊâãÂãïÊñ∞Â¢ûÊôØÈªû',
                    dayIndex, 
                    lat: userLocation?.lat, lng: userLocation?.lng,
                    isCustom: true
                });
                onAdded();
                onClose();
                setName('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center sm:items-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-md p-5 rounded-t-3xl sm:rounded-2xl modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">üìç Êñ∞Â¢û‰∏≠ÈÄîÊôØÈªû</h3>
                        <p className="text-sm text-gray-500 mb-4 bg-gray-100 p-2 rounded-lg inline-block">
                            Day {dayIndex} ¬∑ {dayDate}
                        </p>
                        <input type="time" value={time} onChange={e=>setTime(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-3 font-mono" />
                        <input type="text" placeholder="ÊôØÈªûÂêçÁ®± (Â¶Ç: Ë∑ØÈÇäÂ±ïÊúõÂè∞)" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-4" autoFocus />
                        <p className="text-xs text-gray-400 mb-4"><Icon name="map-pin" size={12} className="inline"/> Â∞áËá™ÂãïË®òÈåÑÁï∂Ââç GPS ‰ΩçÁΩÆ</p>
                        <button onClick={handleSave} className="w-full bg-[#e85a4f] text-white py-3 rounded-xl font-bold text-lg">Êñ∞Â¢ûËá≥Ë°åÁ®ã</button>
                    </div>
                </div>
            );
        };

        const LocationCard = ({ loc, userLocation, day, onExpense }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [photo, setPhoto] = useState(null);
            
            useEffect(() => {
                const checkPhoto = async () => {
                    const saved = await dbOps.getPhoto(`${day}_${loc.name}`);
                    if(saved) setPhoto(saved);
                };
                checkPhoto();
            }, [loc.name, day]);

            const handleCapture = (e) => {
                if (e.target.files?.[0]) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        setPhoto(base64);
                        await dbOps.savePhoto(`${day}_${loc.name}`, base64);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            const distance = useMemo(() => {
                if (!userLocation || !loc.lat || !loc.lng) return null;
                return calculateDistance(userLocation.lat, userLocation.lng, loc.lat, loc.lng);
            }, [userLocation, loc]);

            return (
                <div className={`bg-white p-4 rounded-2xl card-shadow border relative overflow-hidden transition-all duration-300 ${loc.isCustom ? 'border-orange-200 bg-orange-50/30' : 'border-gray-100'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex items-center gap-2">
                            <div className={`p-1.5 rounded-lg ${loc.type === 'food' ? 'bg-orange-100 text-orange-500' : 'bg-gray-100 text-gray-500'}`}>
                                <Icon name={loc.type === 'food' ? 'utensils' : loc.type === 'shop' ? 'shopping-bag' : loc.type === 'transport' ? 'car' : 'map-pin'} size={16} />
                            </div>
                            <span className="font-mono text-lg font-bold text-gray-800">{loc.time}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => onExpense(loc.name)} className="bg-yellow-50 text-yellow-600 p-1.5 rounded-full border border-yellow-200 shadow-sm active:scale-90 flex items-center justify-center w-8 h-8">
                                <Icon name="japanese-yen" size={16} />
                            </button>
                            <label className={`p-1.5 rounded-full cursor-pointer hover:bg-gray-100 active:scale-90 transition-transform flex items-center justify-center w-8 h-8 ${photo ? 'bg-[#e85a4f] text-white shadow-md' : 'bg-gray-50 text-gray-500'}`}>
                                <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleCapture} />
                                <Icon name="camera" size={16} />
                            </label>
                            {loc.link && <a href={loc.link} target="_blank" className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Icon name="navigation" size={12} /> Â∞éËà™</a>}
                        </div>
                    </div>
                    
                    <h3 className="text-xl font-bold text-gray-800 mb-1">{loc.name} {loc.isCustom && <span className="text-[10px] text-orange-500 bg-orange-100 px-1 rounded ml-1">ÊâãÂãï</span>}</h3>
                    
                    {distance && <p className="text-xs text-blue-500 font-bold mb-1 flex items-center gap-1"><Icon name="navigation-2" size={10} /> Ë∑ù {distance}</p>}
                    <p className="text-gray-500 text-sm mb-3">{loc.desc}</p>
                    
                    {photo && <div className="mb-3 relative rounded-lg overflow-hidden border border-gray-200 animate-fade-in"><img src={photo} className="w-full h-32 object-cover" /><div className="absolute bottom-0 right-0 bg-[#e85a4f] text-white text-[10px] px-2 py-1 rounded-tl-lg font-bold">Â∑≤Á¥ÄÈåÑ</div></div>}

                    <div className="flex justify-between items-end">
                        <div className="flex flex-wrap gap-1">{loc.tags && loc.tags.map(tag => <Tag key={tag} text={tag} />)}</div>
                        {loc.details && <button onClick={() => setIsExpanded(!isExpanded)} className="text-gray-400 hover:text-[#e85a4f] flex items-center gap-1 text-xs font-medium p-1 transition-colors">{isExpanded ? 'Êî∂Ëµ∑' : '‰ªãÁ¥π'} <Icon name={isExpanded ? "chevron-up" : "chevron-down"} size={14} /></button>}
                    </div>
                    {isExpanded && loc.details && <div className="mt-4 pt-4 border-t border-gray-100 animate-fade-in text-sm text-gray-600 leading-relaxed text-justify">{loc.details}</div>}
                </div>
            );
        };

        const TabItinerary = ({ tripData, activeDay, setActiveDay, userLocation, onExpense }) => {
            const [mergedLocations, setMergedLocations] = useState([]);
            const [isSpotModalOpen, setIsSpotModalOpen] = useState(false);

            const loadAndMerge = async () => {
                const staticLocs = tripData.find(t => t.day === activeDay)?.locations || [];
                const customSpots = await dbOps.getCustomSpots();
                const dayCustomSpots = customSpots.filter(s => s.dayIndex === activeDay);
                const all = [...staticLocs, ...dayCustomSpots].sort((a, b) => a.time.localeCompare(b.time));
                setMergedLocations(all);
            };

            useEffect(() => { loadAndMerge(); }, [activeDay]);

            const currentTrip = tripData.find(t => t.day === activeDay);

            return (
                <div className="pb-24">
                    <div className="relative h-64 w-full">
                        <img src={currentTrip.image} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                        <div className="absolute bottom-4 left-5 right-5 text-white">
                            <div className="flex items-center gap-2 mb-1 opacity-90">
                                <span className="bg-white/20 backdrop-blur-sm px-2 py-0.5 rounded text-xs font-bold">{currentTrip.date}</span>
                                <span className="flex items-center text-xs"><Icon name="cloud-sun" size={14} className="mr-1"/> {currentTrip.weather}</span>
                            </div>
                            <h2 className="text-3xl font-bold">{currentTrip.title}</h2>
                        </div>
                    </div>

                    <div className="sticky top-0 z-30 bg-[#f8f5f2]/95 backdrop-blur-sm pt-4 pb-2 px-2 shadow-sm">
                        <div className="flex overflow-x-auto gap-3 scrollbar-hide px-2 pb-2">
                            {tripData.map((day) => (
                                <button key={day.day} onClick={() => setActiveDay(day.day)} className={`flex-shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl transition-all ${activeDay === day.day ? "bg-[#e85a4f] text-white shadow-lg scale-105" : "bg-white text-gray-400 border border-gray-100"}`}>
                                    <span className="text-[10px]">D{day.day}</span>
                                    <span className="text-lg font-bold">{day.date.split('/')[1].split(' ')[0]}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="px-5 mt-4 space-y-6">
                        {mergedLocations.map((loc, idx) => (
                            <LocationCard key={idx} loc={loc} userLocation={userLocation} day={currentTrip.day} onExpense={onExpense} />
                        ))}
                        {currentTrip.hotel && <div className="bg-[#2d3436] text-white p-5 rounded-2xl shadow-lg mt-8 mb-4"><h3 className="text-xl font-bold">{currentTrip.hotel.name}</h3></div>}
                    </div>

                    <button 
                        onClick={() => setIsSpotModalOpen(true)}
                        className="fixed bottom-24 right-5 bg-[#e85a4f] text-white p-4 rounded-full shadow-2xl active:scale-90 transition-transform z-40 border-4 border-[#f8f5f2]"
                    >
                        <Icon name="plus" size={28} />
                    </button>

                    <AddSpotModal 
                        isOpen={isSpotModalOpen} 
                        onClose={() => setIsSpotModalOpen(false)} 
                        dayIndex={activeDay}
                        dayDate={currentTrip.fullDate}
                        userLocation={userLocation}
                        onAdded={loadAndMerge} 
                    />
                </div>
            );
        };

        const TabBudget = () => {
            const [expenses, setExpenses] = useState([]);
            useEffect(() => {
                setExpenses(JSON.parse(localStorage.getItem('trip_expenses') || '[]'));
            }, []);

            const total = expenses.reduce((acc, curr) => acc + curr.amount, 0);

            return (
                <div className="px-5 pt-12 pb-24">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">Ê∂àË≤ªÁµ±Ë®à</h2>
                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white p-6 rounded-3xl shadow-lg mb-8 text-center">
                        <span className="text-white/80 text-sm font-medium">Ë®òÂ∏≥Á∏ΩÈ°ç</span>
                        <div className="text-4xl font-bold font-mono mt-1">¬•{total.toLocaleString()}</div>
                    </div>
                    <div className="space-y-3">
                        {expenses.length === 0 && <div className="text-center text-gray-400 py-10">Â∞öÁÑ°Á¥ÄÈåÑÔºåË´ãËá≥Ë°åÁ®ãÈ†ÅÈù¢Ë®òÂ∏≥</div>}
                        {expenses.map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm">
                                <div>
                                    <span className="font-bold text-gray-800 block">{item.name}</span>
                                    <span className="text-xs text-gray-400">{item.date}</span>
                                </div>
                                <span className="font-mono font-bold text-gray-800">¬•{item.amount.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TabInfo = () => <div className="p-5 pt-12"><h2 className="text-2xl font-bold mb-4">ÂäüËÉΩÈÅ∏ÂñÆ</h2><button onClick={exportData} className="w-full bg-blue-500 text-white p-4 rounded-xl font-bold shadow-md">ÂåØÂá∫ÂÆåÊï¥ÈÅäË®òÂÇô‰ªΩ</button></div>;

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [activeDay, setActiveDay] = useState(1);
            const [userLocation, setUserLocation] = useState(null);
            const [expenseModalInfo, setExpenseModalInfo] = useState({ isOpen: false, defaultName: '', defaultDate: '' });

            useEffect(() => {
                if(window.lucide) window.lucide.createIcons();
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }));
                }
            }, [activeTab, activeDay]);

            const currentTripDate = tripData.find(t => t.day === activeDay)?.fullDate;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#f8f5f2] relative shadow-2xl">
                    <div className="fixed top-0 left-0 right-0 z-[60] pointer-events-none flex justify-end p-4"><div className="recording-dot w-3 h-3 bg-red-500 rounded-full"></div></div>

                    {activeTab === 'itinerary' && (
                        <TabItinerary 
                            tripData={tripData} 
                            activeDay={activeDay} 
                            setActiveDay={setActiveDay} 
                            userLocation={userLocation}
                            onExpense={(name) => setExpenseModalInfo({ isOpen: true, defaultName: name, defaultDate: currentTripDate })}
                        />
                    )}
                    {activeTab === 'info' && <TabInfo />}
                    {activeTab === 'budget' && <TabBudget />}

                    <ExpenseModal 
                        isOpen={expenseModalInfo.isOpen} 
                        defaultName={expenseModalInfo.defaultName}
                        defaultDate={expenseModalInfo.defaultDate}
                        onClose={() => setExpenseModalInfo({ ...expenseModalInfo, isOpen: false })}
                    />

                    <div className="fixed bottom-0 left-0 right-0 glass-nav z-50 max-w-md mx-auto">
                        <div className="flex justify-around items-center py-3">
                            <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="map" size={24} /><span className="text-[10px]">Ë°åÁ®ã</span></button>
                            <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 ${activeTab === 'info' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="file-text" size={24} /><span className="text-[10px]">Ë≥áË®ä</span></button>
                            <button onClick={() => setActiveTab('budget')} className={`flex flex-col items-center gap-1 ${activeTab === 'budget' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="wallet" size={24} /><span className="text-[10px]">Áµ±Ë®à</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>