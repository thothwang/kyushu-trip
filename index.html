<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹å·å…«æ—¥è³æ¥“è¡Œæ—…</title>
    
    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f8f5f2; -webkit-tap-highlight-color: transparent; }
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- è¨­å®šèˆ‡å·¥å…· ---
        const DB_NAME = 'KyushuTripDB';
        const STORE_GPS = 'gps_logs';
        const STORE_PHOTOS = 'photos';
        const STORE_CUSTOM_SPOTS = 'custom_spots';
        const STORE_NOTES = 'spot_notes';

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);
                request.onerror = (event) => console.error("DB Error", event);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_GPS)) db.createObjectStore(STORE_GPS, { keyPath: 'timestamp' });
                    if (!db.objectStoreNames.contains(STORE_PHOTOS)) db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORE_CUSTOM_SPOTS)) db.createObjectStore(STORE_CUSTOM_SPOTS, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(STORE_NOTES)) db.createObjectStore(STORE_NOTES, { keyPath: 'id' });
                };
                request.onsuccess = (event) => resolve(event.target.result);
            });
        };

        const dbOps = {
            saveGPS: async (lat, lng) => {
                const db = await initDB();
                db.transaction(STORE_GPS, 'readwrite').objectStore(STORE_GPS).add({ timestamp: Date.now(), lat, lng });
            },
            savePhoto: async (id, base64) => {
                const db = await initDB();
                db.transaction(STORE_PHOTOS, 'readwrite').objectStore(STORE_PHOTOS).put({ id, image: base64, timestamp: Date.now() });
            },
            getPhoto: async (id) => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_PHOTOS, 'readonly').objectStore(STORE_PHOTOS).get(id);
                    req.onsuccess = () => r(req.result?.image);
                });
            },
            deletePhoto: async (id) => {
                const db = await initDB();
                const tx = db.transaction(STORE_PHOTOS, 'readwrite');
                const store = tx.objectStore(STORE_PHOTOS);
                store.delete(id);
                return tx.complete;
            },
            saveNote: async (id, text) => {
                    const db = await initDB();
                    db.transaction(STORE_NOTES, 'readwrite').objectStore(STORE_NOTES).put({ id, text, timestamp: Date.now() });
                },
            getNote: async (id) => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_NOTES, 'readonly').objectStore(STORE_NOTES).get(id);
                    req.onsuccess = () => r(req.result?.text || '');
                });
            },
            
            addCustomSpot: async (spot) => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_CUSTOM_SPOTS, 'readwrite').objectStore(STORE_CUSTOM_SPOTS).add(spot);
                    req.onsuccess = () => r(true);
                });
            },
            getCustomSpots: async () => {
                const db = await initDB();
                return new Promise(r => {
                    const req = db.transaction(STORE_CUSTOM_SPOTS, 'readonly').objectStore(STORE_CUSTOM_SPOTS).getAll();
                    req.onsuccess = () => r(req.result || []);
                });
            }
        };

        const exportData = async () => {
            const db = await initDB();
            const getLogs = (store) => new Promise(r => {
                const req = db.transaction(store, 'readonly').objectStore(store).getAll();
                req.onsuccess = () => r(req.result);
            });
            const [gps, photos, customSpots, notes] = await Promise.all([
                    getLogs(STORE_GPS), getLogs(STORE_PHOTOS), getLogs(STORE_CUSTOM_SPOTS), getLogs(STORE_NOTES) // æ–°å¢ getLogs(STORE_NOTES)
                ]);
            const expenses = JSON.parse(localStorage.getItem('trip_expenses') || '[]');
            const data = { gps, photos, customSpots, notes, expenses, exportTime: new Date().toLocaleString() };
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `kyushu_trip_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            if (!lat1 || !lon1 || !lat2 || !lon2) return null;
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c;
            return d < 1 ? `${Math.round(d * 1000)}m` : `${d.toFixed(1)}km`;
        };

        // --- å®Œæ•´è¡Œç¨‹è³‡æ–™ (ä¿ç•™æ‚¨çš„è©³ç´°ä»‹ç´¹èˆ‡ jpg åœ–ç‰‡) ---
        const tripData = [
            {
                day: 1,
                date: "11/29 (äº”)",
                fullDate: "2025-11-29",
                title: "ç§‹æœˆå¤åŸèˆ‡éŠ€æ",
                weather: "æ™´æ™‚å¤šé›² 15Â°C",
                image: "./images/1.jpg",
                route: "ç†Šæœ¬æ©Ÿå ´ â†’ å¤ªåŸéŠ€æ â†’ ç§‹æœˆåŸè·¡",
                locations: [
                    { time: "10:00", name: "ç†Šæœ¬æ©Ÿå ´ (KMJ)", desc: "å–è»Šå‡ºç™¼", type: "transport", lat: 32.8372, lng: 130.8569 },
                    { 
                        time: "12:30", 
                        name: "å¤ªåŸéŠ€ææ£®æ—", 
                        desc: "çµ•ç¾é‡‘é»ƒåœ°æ¯¯", 
                        type: "spot", 
                        tags: ["å¿…æ‹", "å­£ç¯€é™å®š"], 
                        link: "https://www.google.com/maps/search/?api=1&query=å¤ªåŸéŠ€ææ£®æ—",
                        lat: 33.2725, lng: 130.6389,
                        details: "ä½æ–¼å»£å·ç”ºçš„ç§äººéŠ€ææ—ï¼Œåªæœ‰åœ¨ç§‹å­£ç´…è‘‰æœŸé–“æ‰ç‰¹åˆ¥å°å¤–é–‹æ”¾ã€‚é€™è£¡ç¨®æ¤äº†ç´„80æ£µä½çŸ®çš„éŠ€ææ¨¹ï¼Œå› ç‚ºæ¨¹é«˜è¼ƒä½ï¼Œéå¸¸é©åˆäººåƒæ”å½±ã€‚ç•¶è½è‘‰é‹ªæ»¿åœ°é¢æ™‚ï¼Œå°±åƒèµ°åœ¨ä¸€æ¢é‡‘é»ƒè‰²çš„åœ°æ¯¯ä¸Šï¼Œæ˜¯è¿‘å¹´ä¹å·IGçˆ†ç´…çš„ç§˜å¢ƒã€‚"
                    },
                    { 
                        time: "14:30", 
                        name: "å¤§èˆˆå–„å¯º", 
                        desc: "ç´…è‘‰éšæ¢¯çµ•æ™¯", 
                        type: "spot", 
                        tags: ["ç´…è‘‰åæ‰€"], 
                        link: "https://www.google.com/maps/search/?api=1&query=å¤§èˆˆå–„å¯º",
                        lat: 33.4357, lng: 130.5367,
                        details: "æ“æœ‰1300å¹´æ­·å²çš„å¤è€å¯ºå»Ÿï¼Œä½æ–¼ä½è³€èˆ‡ç¦å²¡çš„äº¤ç•Œã€‚å¾å±±è…³ä¸‹çš„åœè»Šå ´æ²¿è‘—åƒé“èµ°ä¸Šå»ï¼Œæœƒç¶“éè‘—åçš„ã€Œ127æ®µçŸ³éšã€ï¼Œå…©æ—æ¥“ç´…æ©æ˜ ï¼Œæ˜¯æ”å½±æ„›å¥½è€…çš„æœ€æ„›ã€‚å¯ºå¾Œçš„ã€Œå¥‘åœ’ã€ç¨®æ¤äº†500å¤šæ£µæ¥“æ¨¹ï¼Œèˆ‡èŒ…è‰å±‹é ‚çš„æœ¬å ‚ç›¸æ˜ æˆè¶£ã€‚"
                    },
                    { 
                        time: "16:30", 
                        name: "ç§‹æœˆåŸè·¡", 
                        desc: "é»‘é–€èˆ‡æ¥“è‘‰çš„å°æ¯”", 
                        type: "spot", 
                        tags: ["å°äº¬éƒ½"], 
                        link: "https://www.google.com/maps/search/?api=1&query=ç§‹æœˆåŸè·¡",
                        lat: 33.4667, lng: 130.6942,
                        details: "è¢«ç¨±ç‚ºã€Œç­‘å‰çš„å°äº¬éƒ½ã€ï¼Œä¿ç•™äº†æ±Ÿæˆ¶æ™‚ä»£çš„åŸä¸‹ç”ºé¢¨è²Œã€‚å¿…çœ‹çš„æ˜¯ã€Œé»‘é–€ã€ï¼Œé€™åŸæœ¬æ˜¯ç§‹æœˆåŸçš„æ­£é–€ï¼Œé»‘è‰²çš„æœ¨é€ å»ºç¯‰åœ¨å‘¨åœç«ç´…æ¥“è‘‰çš„è¥¯æ‰˜ä¸‹ï¼Œé¡¯å¾—æ ¼å¤–èŠåš´ç¾éº—ã€‚å»ºè­°å¯ä»¥åœ¨é™„è¿‘çš„èŒ¶å±‹å“åšè‘›é¤…ã€‚" 
                    },
                ],
                hotel: { name: "Akizuki OKO art+inn", price: 33000, link: "https://www.google.com/maps/search/?api=1&query=Akizuki+OKO" }
            },
            {
                day: 2,
                date: "11/30 (å…­)",
                fullDate: "2025-11-30",
                title: "ç¦å²¡ç¹è¯å·¡ç¦®",
                weather: "å¤šé›² 14Â°C",
                image: "./images/2.jpg",
                locations: [
                    { time: "11:30", name: "å¤©ç¥åœ°ä¸‹è¡—", desc: "å¥½é€›å¥½è²·", type: "shop", tags: ["ä¼´æ‰‹ç¦®", "è—¥å¦"], link: "https://www.google.com/maps/search/?api=1&query=å¤©ç¥åœ°ä¸‹è¡—", lat: 33.5915, lng: 130.3989, details: "ä¹å·æœ€å¤§çš„åœ°ä¸‹è³¼ç‰©ä¸­å¿ƒï¼Œå…¨é•·ç´„600å…¬å°ºï¼Œé¢¨æ ¼æ¨¡ä»¿19ä¸–ç´€æ­æ´²è¡—é“ï¼ŒçŸ³æ¿åœ°èˆ‡é‘„éµè£é£¾éå¸¸æœ‰æ°£æ°›ã€‚é€£æ¥äº†å„å¤§ç™¾è²¨å…¬å¸èˆ‡åœ°éµç«™ï¼Œé›†çµäº†æµè¡Œæœé£¾ã€é›œè²¨èˆ‡å¿…è²·ä¼´æ‰‹ç¦®ï¼ˆå¦‚Bake Cheese Tartã€éˆ´æ‡¸ç­‰ï¼‰ã€‚" },
                    { time: "13:30", name: "ä¸€è˜­æ‹‰éºµ ç¸½æœ¬åº—", desc: "ç¦å²¡é™å®šæ–¹ç¢—", type: "food", tags: ["å¿…åƒ", "æ’éšŠ"], link: "https://www.google.com/maps/search/?api=1&query=ä¸€è˜­æ‹‰éºµç¸½æœ¬åº—", lat: 33.5932, lng: 130.4046, details: "ä¸€è˜­æ‹‰éºµçš„ç¸½éƒ¨å¤§æ¨“ï¼Œåªæœ‰åœ¨é€™è£¡å¯ä»¥ç”¨ã€Œæ–¹ç¢—ï¼ˆé‡ç®±ã©ã‚“ã¶ã‚Šï¼‰ã€åƒæ‹‰éºµï¼Œéå¸¸æœ‰å„€å¼æ„Ÿã€‚ä¸€æ¨“æ˜¯å±‹å°é¢¨æ ¼åº§ä½ï¼ŒäºŒæ¨“ä»¥ä¸Šå‰‡æ˜¯ç¶“å…¸çš„å‘³é›†ä¸­åº§ä½ã€‚" },
                    { time: "18:00", name: "ä¸­æ´²å±‹å°", desc: "é«”é©—åœ¨åœ°å¤œç”Ÿæ´»", type: "food", tags: ["é—œæ±ç…®", "æ˜å¤ªå­"], link: "https://www.google.com/maps/search/?api=1&query=ä¸­æ´²å±‹å°æ©«ä¸", lat: 33.5923, lng: 130.4069, details: "é‚£ç‚å·æ²¿å²¸æ—ç«‹çš„å±‹å°è¡—æ˜¯ç¦å²¡çš„å¤œæ™šè±¡å¾µã€‚å»ºè­°é»ä¸€ä»½åšå¤šè‘—åçš„ã€Œæ˜å¤ªå­ç‰å­ç‡’ã€é…ä¸Šå•¤é…’ã€‚å¦‚æœä¸ç¿’æ…£è·¯é‚Šæ”¤ï¼Œä¹Ÿå¯ä»¥å»é‹æ²³åŸé™„è¿‘çš„é¤å»³ã€‚" },
                ],
                hotel: { name: "åšå¤š RESOL TRINITY", price: 50000, link: "https://www.google.com/maps/search/?api=1&query=Hotel+Resol+Trinity+Hakata" }
            },
            {
                day: 3,
                date: "12/01 (æ—¥)",
                fullDate: "2025-12-01",
                title: "è€¶é¦¬æºªèˆ‡åˆ¥åºœ",
                weather: "æ™´å¤© 12Â°C",
                image: "./images/3.jpg",
                locations: [
                    { time: "11:30", name: "æ·±è€¶é¦¬æºª", desc: "ä¸€ç›®å…«æ™¯ï¼Œå¥‡å²©èˆ‡ç´…è‘‰", type: "spot", tags: ["çµ•æ™¯"], link: "https://www.google.com/maps/search/?api=1&query=æ·±è€¶é¦¬æºªä¸€ç›®å…«æ™¯", lat: 33.3725, lng: 131.0664, details: "è€¶é¦¬æºªæ˜¯ä¹å·æœ€è‘—åçš„ç´…è‘‰å³½è°·ï¼Œå…¶ä¸­ã€Œä¸€ç›®å…«æ™¯ã€æ˜¯æœ€ç²¾è¯çš„å±•æœ›å°ï¼Œç«™åœ¨é€™è£¡å¯ä»¥ä¸€çœ¼æœ›ç›¡å‘¨åœå…«åº§å¥‡å½¢æ€ªç‹€çš„å²©å³°ï¼ˆå¦‚ç¾¤çŒ¿å±±ã€ä»™äººå²©ç­‰ï¼‰ã€‚ç§‹å­£æ™‚ï¼Œç°ç™½çš„å²©çŸ³èˆ‡ç«ç´…çš„æ¥“è‘‰å½¢æˆå¼·çƒˆå°æ¯”ï¼Œæ™¯è‰²å£¯éº—ã€‚" },
                    { time: "14:00", name: "å¯Œè²´å¯º", desc: "åœ‹å¯¶å¤§å ‚", type: "spot", tags: ["å¤å‰"], link: "https://www.google.com/maps/search/?api=1&query=å¯Œè²´å¯º", lat: 33.5414, lng: 131.5283, details: "ä¹å·ç¾å­˜æœ€å¤è€çš„æœ¨é€ å»ºç¯‰ä¹‹ä¸€ï¼Œå…¶ã€Œå¤§å ‚ã€è¢«æŒ‡å®šç‚ºæ—¥æœ¬åœ‹å¯¶ã€‚å»ºç¯‰é¢¨æ ¼ç°¡æ¨¸èŠåš´ï¼Œç§‹å­£æ™‚å¤§å ‚å‘¨åœæœƒè¢«å·¨å¤§çš„éŠ€ææ¨¹èˆ‡æ¥“è‘‰åŒ…åœï¼Œé‡‘é»ƒèˆ‡æœ±ç´…è½è‘‰é‹ªæ»¿åº­é™¢ï¼Œå‘ˆç¾å‡ºæ¥µå…·ç¦ªæ„çš„å¹³å®‰æ™‚ä»£ç¾å­¸ã€‚" },
                    { time: "17:00", name: "åˆ¥åºœæº«æ³‰", desc: "åœ°ç„è’¸æ–™ç†æ™šé¤", type: "relax", tags: ["æº«æ³‰"], link: "https://www.google.com/maps/search/?api=1&query=åˆ¥åºœæº«æ³‰", lat: 33.2800, lng: 131.5000, details: "æ—¥æœ¬æ¹§æ³‰é‡ç¬¬ä¸€çš„æº«æ³‰åœ°ï¼Œæ•´å€‹åŸå¸‚éš¨è™•å¯è¦‹æº«æ³‰è’¸æ°£ï¼ˆæ¹¯ç…™ï¼‰å†’å‡ºã€‚é™¤äº†è‘—åçš„åœ°ç„å·¡ç¦®ï¼Œé€™è£¡çš„æº«æ³‰æ³‰è³ªå¤šæ¨£ã€‚æ‚¨å…¥ä½çš„æµ·æ™¯æº«æ³‰å¯ä»¥ä¸€é‚Šæ³¡æ¹¯ä¸€é‚Šçœºæœ›åˆ¥åºœç£ï¼Œæ˜¯æ¶ˆé™¤é•·é€”é§•é§›ç–²å‹çš„æœ€ä½³äº«å—ã€‚"},
                ],
                hotel: { name: "åˆ¥åºœ Airbnb", price: 23000, link: "" }
            },
            {
                day: 4,
                date: "12/02 (ä¸€)",
                fullDate: "2025-12-02",
                title: "ç”±å¸ƒé™¢ç«¥è©±æ•£ç­–",
                weather: "é™°æ™‚å¤šé›² 11Â°C",
                image: "./images/4.jpg",
                locations: [
                    { time: "11:00", name: "åˆ¥åºœæµ·é®®å¸‚å ´", desc: "åˆé¤åƒæ–°é®®æµ·é®®", type: "food", tags: ["æµ·é®®ä¸¼"], link: "", lat: 33.3000, lng: 131.5000, details: "ä½æ–¼åˆ¥åºœç£æ—ï¼Œæä¾›æœ€æ–°é®®çš„è±å¾Œæ°´é“æµ·ç”¢ã€‚æ¨è–¦å“åšå¤§åˆ†ç¸£ç‰¹ç”¢ã€Œé—œé¯–é­šã€èˆ‡ã€Œé—œç«¹è¢é­šã€ï¼Œè‚‰è³ªç·Šå¯¦é®®ç”œã€‚ä¹Ÿå¯ä»¥é¸æ“‡æµ·é®®ç‡’çƒ¤æˆ–è±ªé‚çš„æµ·é®®ä¸¼é£¯ä½œç‚ºåˆé¤ã€‚" },
                    { time: "14:30", name: "æ¹¯ä¹‹åªè¡—é“", desc: "å²åŠªæ¯”èŒ¶å±‹ã€ç«¥è©±æ‘", type: "walk", tags: ["å¥½é€›"], link: "https://www.google.com/maps/search/?api=1&query=æ¹¯ä¹‹åªè¡—é“", lat: 33.2667, lng: 131.3583, details: "é€£æ¥ç”±å¸ƒé™¢è»Šç«™èˆ‡é‡‘é±—æ¹–çš„ä¸»è¦è¡—é“ï¼Œå…©æ—æ—ç«‹è‘—å„å¼ç‰¹è‰²å°åº—ã€é›œè²¨èˆ–èˆ‡ç”œé»åº—ã€‚å¿…è¨ªçš„ã€ŒYufuin Floral Villageã€æ˜¯ä»¿ç…§è‹±åœ‹ç§‘èŒ¨æ²ƒçˆ¾å¾·æ‰“é€ çš„ç«¥è©±æ‘ï¼Œå……æ»¿å“ˆåˆ©æ³¢ç‰¹èˆ¬çš„æ°›åœï¼Œéå¸¸é©åˆæ‹ç…§ã€‚" },
                    { time: "15:00", name: "Milch èµ·å¸è›‹ç³•", desc: "å¿…åƒç†±èµ·å¸è›‹ç³•", type: "food", tags: ["å¿…åƒç”œé»"], link: "https://www.google.com/maps/search/?api=1&query=Milchç”±å¸ƒé™¢", lat: 33.2650, lng: 131.3570, details: "æ›¾ç²å¾—ä¸–ç•Œé‡‘è³çš„ç”œé»ååº—ã€‚æ‹›ç‰Œã€ŒKase Kuchenã€åŠç†Ÿèµ·å¸è›‹ç³•ï¼Œæœ‰ç†±åƒèˆ‡å†·åƒå…©ç¨®å£æ„Ÿã€‚æ¨è–¦å˜—è©¦ç†±çš„ï¼Œç”¨æ¹¯åŒ™æŒ–ä¸‹å»ï¼Œä¸­é–“æ¿ƒéƒçš„èµ·å¸å…§é¤¡æœƒç·©ç·©æµå‡ºï¼Œå¥¶é¦™æ¿ƒéƒä¸”ä¸è†©å£ã€‚" },
                    { time: "16:00", name: "é‡‘éºŸæ¹–", desc: "æ¹–ä¸Šé³¥å±…", type: "spot", tags: ["æ‹ç…§"], link: "https://www.google.com/maps/search/?api=1&query=é‡‘éºŸæ¹–", lat: 33.2625, lng: 131.3620, details: "ç”±å¸ƒé™¢çš„è±¡å¾µï¼Œæ¹–åº•åŒæ™‚æ¹§å‡ºæº«æ³‰èˆ‡æ¸…æ°´ï¼Œå› æ­¤åœ¨ç§‹å†¬çš„æ¸…æ™¨ï¼Œæ¹–é¢æœƒå› ç‚ºæº«å·®é£„æ•£è‘—å¤¢å¹»çš„ç™½è‰²æ™¨éœ§ï¼ˆæœéœ§ï¼‰ã€‚æ¹–ç•”çš„ã€Œå¤©ç¥–ç¥ç¤¾ã€æ°´ä¸Šé³¥å±…èˆ‡æ¥“è‘‰å€’å½±ï¼Œæ˜¯æ—©èµ·æ•£æ­¥æ‰èƒ½çœ‹åˆ°çš„çµ•æ™¯ã€‚"},
                ],
                hotel: { name: "ç”±å¸ƒé™¢ Airbnb", price: 40200, link: "" }
            },
            {
                day: 5,
                date: "12/03 (äºŒ)",
                fullDate: "2025-12-03",
                title: "é»‘å·æº«æ³‰ç§˜å¢ƒ",
                weather: "é›¨å¾Œè½‰æ™´ 9Â°C",
                image: "./images/5.jpg",
                locations: [
                    { time: "09:00", name: "B-speak", desc: "æ’éšŠè²·ç”Ÿä¹³æ²", type: "food", tags: ["é™é‡"], link: "https://www.google.com/maps/search/?api=1&query=B-speak", lat: 33.2645, lng: 131.3550, details: "ç”±å¸ƒé™¢æº«æ³‰æ—…é¤¨ã€Œå±±èŠ ç„¡é‡å¡”ã€é–‹è¨­çš„è›‹ç³•æ²å°ˆè³£åº—ã€‚å …æŒä¸æ·»åŠ äººå·¥é¦™æ–™ï¼Œæµ·ç¶¿è›‹ç³•è“¬é¬†æ¿•æ½¤ï¼Œé®®å¥¶æ²¹ç”œåº¦é©ä¸­ä¸”æ¸…çˆ½ã€‚å› ç‚ºéå¸¸æ¶æ‰‹ï¼Œé€šå¸¸å»ºè­°é–‹åº—å‰å°±å»æ’éšŠï¼Œæˆ–è³¼è²·åˆ‡ç‰‡è£åœ¨è»Šä¸Šäº«ç”¨ã€‚" },
                    { time: "12:30", name: "é‹ãƒ¶æ» ç€‘å¸ƒ", desc: "å¯é€²å…¥å…§éƒ¨çš„ç€‘å¸ƒ", type: "spot", tags: ["ç§˜å¢ƒ"], link: "https://www.google.com/maps/search/?api=1&query=é‹ãƒ¶æ»", lat: 33.1167, lng: 131.0250, details: "å› èŒ¶é£²å»£å‘Šè€Œè²åå¤§å™ªçš„æ™¯é»ã€‚æœ€å¤§çš„ç‰¹è‰²æ˜¯å¯ä»¥èµ°åˆ°ç€‘å¸ƒçš„ã€ŒèƒŒé¢ã€ï¼Œå¾æ°´ç°¾å¾Œæ–¹å¾€å¤–çœ‹ï¼Œé™½å…‰ç©¿é€æ°´ç èˆ‡æ¨¹æ—çš„æ™¯è‰²éå¸¸å¤¢å¹»ã€‚ç€‘å¸ƒå¯¬ç´„20å…¬å°ºï¼Œè½å·®ä¸å¤§ä½†å§¿æ…‹å„ªé›…ã€‚" },
                    { time: "14:30", name: "é»‘å·æº«æ³‰", desc: "è³¼è²·å…¥æ¹¯æ‰‹å½¢æ³¡æ¹¯", type: "relax", tags: ["ç±³å…¶æ—äºŒæ˜Ÿ"], link: "https://www.google.com/maps/search/?api=1&query=é»‘å·æº«æ³‰", lat: 33.0783, lng: 131.1394, details: "è¢«ç±³å…¶æ—ç¶ è‰²æŒ‡å—è©•ç‚ºäºŒæ˜Ÿçš„æº«æ³‰åœ°ã€‚é€™è£¡ç‚ºäº†ç¶­è­·æ™¯è§€ï¼Œå…¨å€å»ºç¯‰é¢¨æ ¼çµ±ä¸€ï¼Œå……æ»¿æ¿ƒåšçš„æ±Ÿæˆ¶è‰²å½©ã€‚åˆ©ç”¨ã€Œå…¥æ¹¯æ‰‹å½¢ã€å¯ä»¥ä»»é¸ä¸‰å®¶æ—…é¤¨çš„éœ²å¤©æº«æ³‰é«”é©—ã€‚æ¨è–¦å“åšæº«æ³‰è¡—ä¸Šçš„ã€ŒPatisserie Rokuã€ç”Ÿä¹³æ³¡èŠ™ï¼Œå¤–çš®é…¥è„†å…§é¤¡é£½æ»¿ã€‚" },
                ],
                hotel: { name: "å±±ã¿ãšæœ¨", price: 105600, link: "https://www.google.com/maps/search/?api=1&query=å±±ã¿ãšæœ¨" }
            },
            {
                day: 6,
                date: "12/04 (ä¸‰)",
                fullDate: "2025-12-04",
                title: "é˜¿è˜‡ç«å±±èˆ‡ç¥è©±",
                weather: "æ™´æœ— 8Â°C",
                image: "./images/6.jpg",
                locations: [
                    { time: "12:30", name: "é˜¿è˜‡å¤§è§€å³°", desc: "çœºæœ›æ¶…æ§ƒåƒ", type: "spot", tags: ["å£¯è§€"], link: "https://www.google.com/maps/search/?api=1&query=é˜¿è˜‡å¤§è§€å³°", lat: 33.0333, lng: 131.0833, details: "ä½æ–¼ä¹é‡é€£å±±èˆ‡é˜¿è˜‡å±±ä¹‹é–“çš„é«˜åŸç”œé»åº—ã€‚åº—å…§æ‹›ç‰Œæ˜¯å¹´è¼ªè›‹ç³•èˆ‡ç‘å£«æ²ã€‚æœ€æ£’çš„æ˜¯å¯ä»¥åœ¨éœ²å°åº§ä½å€ï¼Œä¸€é‚Šäº«ç”¨ç²¾ç·»ç”œé»ï¼Œä¸€é‚Šçœºæœ›é˜¿è˜‡äº”å²³çš„å£¯é—Šå…¨æ™¯ï¼Œæ˜¯è‡ªé§•é€”ä¸­çš„æœ€ä½³ä¼‘æ¯ç«™ã€‚" },
                    { time: "13:30", name: "è‰åƒé‡Œ", desc: "é¨é¦¬é«”é©—", type: "spot", tags: [], link: "https://www.google.com/maps/search/?api=1&query=è‰åƒé‡Œ", lat: 32.8842, lng: 131.0514, details: "ä½æ–¼çƒå¸½å­å²³åŒ—éº“çš„ä¸€ç‰‡å·¨å¤§åœ“å½¢è‰åŸï¼ŒåŸæœ¬æ˜¯ç«å±±å£éºè·¡ã€‚ä¸­å¤®æœ‰å…©å€‹é›¨æ°´å½¢æˆçš„æ± å¡˜ï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ä»åœ¨å†’ç…™çš„ä¸­å²³ç«å±±å£ã€‚é€™è£¡å¯ä»¥é«”é©—é¨é¦¬æ•£æ­¥ï¼Œæ™¯è‰²é–‹é—Šå£¯éº—ï¼Œæ˜¯é˜¿è˜‡æœ€å…·ä»£è¡¨æ€§çš„æ™¯é»ã€‚" },
                    { time: "16:00", name: "é«˜åƒç©—ç¥ç¤¾", desc: "å¤œç¥æ¨‚", type: "spot", tags: ["ç¥è©±"], link: "https://www.google.com/maps/search/?api=1&query=é«˜åƒç©—ç¥ç¤¾", lat: 32.7100, lng: 131.3000, details: "ç´„1900å¹´å‰å‰µå»ºçš„å¤è€ç¥ç¤¾ï¼Œæ˜¯é«˜åƒç©—é„‰å…«åå…«ç¤¾çš„ç¸½ç¤¾ã€‚å¢ƒå…§æœ‰æ¨¹é½¡è¶…é800å¹´çš„ã€Œç§©çˆ¶æ‰ã€èˆ‡å…©æ£µæ ¹éƒ¨ç›¸é€£çš„ã€Œå¤«å©¦æ‰ã€ï¼Œæ“šèªªç‰½æ‰‹ç¹è¡Œä¸‰åœˆèƒ½ä¿ä½‘å§»ç·£ç¾æ»¿ã€‚æ¯æ™šé€™è£¡ä¹Ÿæœƒèˆ‰è¾¦æ¼”ç¹¹ç¥è©±æ•…äº‹çš„ã€Œå¤œç¥æ¨‚ã€ã€‚" },
                ],
                hotel: { name: "Hotel Takachiho", price: 65600, link: "https://www.google.com/maps/search/?api=1&query=Hotel+Takachiho" }
            },
            {
                day: 7,
                date: "12/05 (å››)",
                fullDate: "2025-12-05",
                title: "é«˜åƒç©—åˆ’èˆ¹",
                weather: "å¤šé›² 10Â°C",
                image: "./images/7.jpg",
                locations: [
                    { time: "09:00", name: "é«˜åƒç©—å³½", desc: "å³½è°·åˆ’èˆ¹ (è¨˜å¾—é ç´„)", type: "spot", tags: ["å¿…å»", "é ç´„"], link: "https://www.google.com/maps/search/?api=1&query=é«˜åƒç©—å³½", lat: 32.7050, lng: 131.3000, details: "ç”±é˜¿è˜‡ç«å±±å™´ç™¼çš„ç†”å²©æ€¥é½å†·å»å¾Œå½¢æˆçš„æŸ±ç‹€ç¯€ç†å³½è°·ã€‚æœ€ç¶“å…¸çš„ç©æ³•æ˜¯åˆ’èˆ¹è¿‘è·é›¢è§€è³ã€ŒçœŸåäº•ç€‘å¸ƒã€ï¼Œç€‘å¸ƒå¾17å…¬å°ºé«˜çš„å³­å£å‚¾ç€‰è€Œä¸‹ï¼Œæ°´æ°£èˆ‡å…‰å½±äº¤éŒ¯ï¼Œå®›å¦‚é€²å…¥ç¥è©±ä¸–ç•Œã€‚" },
                    { time: "12:00", name: "é«˜åƒç©—ç‰›ç‡’è‚‰ å’Œ", desc: "é ‚ç´šå’Œç‰›åˆé¤", type: "food", tags: ["å¿…åƒ"], link: "https://www.google.com/maps/search/?api=1&query=é«˜åƒç©—ç‰›ç‡’è‚‰å’Œ", lat: 32.7100, lng: 131.3050, details: "æ›¾ç²å¾—ã€Œæ—¥æœ¬ä¸€ã€æ®Šæ¦®çš„é«˜åƒç©—ç‰›ï¼Œä»¥è„‚è‚ªåˆ†å¸ƒå‡å‹»ã€å£æ„Ÿä¸æ²¹è†©è‘—ç¨±ã€‚é€™å®¶é¤å»³æ˜¯JAï¼ˆè¾²æœƒï¼‰ç›´ç‡Ÿï¼Œèƒ½ä»¥ç›¸å°å¯¦æƒ çš„åƒ¹æ ¼åƒåˆ°æœ€é«˜å“è³ªçš„ç‰›è‚‰ã€‚åˆé¤æ™‚æ®µçš„ç‰›æ’å¥—é¤CPå€¼éå¸¸é«˜ã€‚" },
                    {
                        time: "15:30",
                        name: "æ°´å‰å¯ºæˆè¶£åœ’",
                        desc: "ç¸®å°ç‰ˆçš„æ±æµ·é“äº”åä¸‰æ¬¡",
                        type: "spot",
                        tags: ["åº­åœ’", "æ•£æ­¥"],
                        link: "https://www.google.com/maps/search/?api=1&query=æ°´å‰å¯ºæˆè¶£åœ’",
                        lat: 32.7900, lng: 130.7300,
                        details: "ç†Šæœ¬è—©ä¸»ç´°å·å®¶æ­·ç¶“ä¸‰ä»£å»ºé€ çš„æ¡ƒå±±å¼è¿´éŠåº­åœ’ã€‚åº­åœ’è¨­è¨ˆæ¨¡ä»¿äº†æ±æµ·é“äº”åä¸‰æ¬¡çš„æ™¯è‰²ï¼Œå…¶ä¸­æœ€è‘—åçš„å°±æ˜¯æ¨¡ä»¿ã€Œå¯Œå£«å±±ã€çš„å‡å±±ã€‚æ± æ°´å¼•è‡ªé˜¿è˜‡ä¼æµæ°´ï¼Œæ¸…æ¾ˆè¦‹åº•ã€‚ç§‹å­£æ™‚åº­åœ’å…§çš„æ¥“æ¨¹èˆ‡æ¾æ¨¹ç›¸äº’è¼æ˜ ï¼Œæ™¯è‰²å„ªé›…ã€‚"
                    },
                    {
                        time: "16:30",
                        name: "æµ·è³Šç‹é­¯å¤«é›•åƒ",
                        desc: "èˆªæµ·ç‹ç²‰çµ²è–åœ°",
                        type: "spot",
                        tags: ["å‹•æ¼«", "éŠ€æ"],
                        link: "https://www.google.com/maps/search/?api=1&query=ç†Šæœ¬ç¸£å»³+é­¯å¤«åƒ",
                        lat: 32.7950, lng: 130.7400,
                        details: "ä½æ–¼ç†Šæœ¬ç¸£å»³æ•£æ­¥é“ä¸Šï¼Œæ˜¯ç‚ºäº†æ„Ÿè¬ä½œè€…å°¾ç”°æ¦®ä¸€éƒå°ç†Šæœ¬åœ°éœ‡å¾©èˆˆçš„è²¢ç»è€Œè¨­ç«‹ã€‚é€™å°Šé­¯å¤«éŠ…åƒé‚„åŸåº¦æ¥µé«˜ã€‚ç§‹å­£é€ è¨ªæ™‚ï¼Œç¸£å»³å‰çš„å…©æ’éŠ€æå¤§é“æœƒè®Šæˆé‡‘é»ƒè‰²ï¼Œå‰›å¥½æˆç‚ºé­¯å¤«èº«å¾Œæœ€å£¯è§€çš„èƒŒæ™¯ã€‚"
                    }
                ],
                hotel: { name: "ä¸‰äº•èŠ±åœ’é£¯åº— ç†Šæœ¬", price: 38000, link: "https://www.google.com/maps/search/?api=1&query=ä¸‰äº•èŠ±åœ’é£¯åº—ç†Šæœ¬" }
            },
             {
                day: 8,
                date: "12/06 (äº”)",
                fullDate: "2025-12-06",
                title: "è¿”å°",
                weather: "æ™´ 16Â°C",
                image: "./images/8.jpg",
                locations: [
                    { time: "11:30", name: "ç†Šæœ¬æ©Ÿå ´", desc: "é‚„è»Šã€æœ€å¾Œæ¡è²·", type: "transport", tags: [], link: "https://www.google.com/maps/search/?api=1&query=ç†Šæœ¬æ©Ÿå ´", lat: 32.8372, lng: 130.8569 },
                ],
                hotel: null
            }
        ];

        // --- çµ„ä»¶ ---
        // ä¿®æ­£ Icon çµ„ä»¶ï¼Œä½¿ç”¨ React çš„ dangerouslySetInnerHTML ä¾†ç¢ºä¿æ¸²æŸ“
        const Icon = ({ name, size = 18, className }) => {
            const [iconHtml, setIconHtml] = useState('');
            
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const iconKey = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                    const iconNode = window.lucide.icons[iconKey] || window.lucide.icons.CircleHelp;
                    
                    // æ‰‹å‹•å»ºç«‹ SVG å­—ä¸²
                    // Lucide çš„åœ–ç¤ºæ˜¯å€‹äºŒç¶­é™£åˆ—ï¼Œæˆ‘å€‘éœ€è¦è½‰æˆ SVG
                    // ä½†æœ€ç°¡å–®çš„æ–¹æ³•æ˜¯ä½¿ç”¨ lucide.createIcons ç”¢ç”Ÿçš„ HTMLï¼Œ
                    // é€™è£¡ç‚ºäº† React ç©©å®šæ€§ï¼Œæˆ‘å€‘ä½¿ç”¨ lucide çš„ toSvg æ–¹æ³• (å¦‚æœç‰ˆæœ¬æ”¯æ´)
                    // æˆ–è€…æ›´ç°¡å–®ï¼šæˆ‘å€‘ç›´æ¥è®“ lucide æ›¿æ›ä¸€å€‹è‡¨æ™‚å…ƒç´ 
                    
                    const temp = document.createElement('div');
                    const iconElement = window.lucide.createElement(iconNode);
                    iconElement.setAttribute('width', size);
                    iconElement.setAttribute('height', size);
                    if(className) iconElement.setAttribute('class', className);
                    temp.appendChild(iconElement);
                    setIconHtml(temp.innerHTML);
                }
            }, [name, size, className]);

            return <span dangerouslySetInnerHTML={{ __html: iconHtml }} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
        };

        const Tag = ({ text }) => <span className={`text-[10px] px-2 py-1 rounded-full font-bold mr-1 bg-gray-100 text-gray-600`}>{text}</span>;

        // è¨˜å¸³ Modal
        const ExpenseModal = ({ isOpen, onClose, defaultName, defaultDate }) => {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('food');

            useEffect(() => { 
                if(isOpen && defaultName) setName(defaultName); 
            }, [isOpen, defaultName]);

            const handleSave = () => {
                const dateToUse = defaultDate || new Date().toLocaleDateString();
                const newItem = { 
                    id: Date.now(), 
                    name, 
                    amount: parseInt(amount), 
                    category: cat, 
                    date: dateToUse, 
                    location: defaultName 
                };
                const saved = JSON.parse(localStorage.getItem('trip_expenses') || '[]');
                localStorage.setItem('trip_expenses', JSON.stringify([newItem, ...saved]));
                onClose();
                alert(`å·²è¨˜éŒ„æ–¼ ${dateToUse}ï¼š${name} Â¥${amount}`);
                setName(''); setAmount('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center sm:items-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-md p-5 rounded-t-3xl sm:rounded-2xl modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="wallet" /> è¨˜å¸³ {defaultDate && <span className="text-sm font-normal text-gray-500">({defaultDate})</span>}
                            </h3>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        <input type="text" placeholder="é …ç›®" value={name} onChange={e => setName(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-3 text-lg font-bold" />
                        <input type="number" placeholder="Â¥ é‡‘é¡" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-4 text-lg font-mono" autoFocus />
                        <div className="flex gap-2 mb-6">
                            {['food','transport','shop','other'].map(c => (
                                <button key={c} onClick={() => setCat(c)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${cat===c ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-400'}`}>
                                    {c==='food'?'é¤é£²':c==='transport'?'äº¤é€š':c==='shop'?'è³¼ç‰©':'å…¶ä»–'}
                                </button>
                            ))}
                        </div>
                        <button onClick={handleSave} disabled={!name || !amount} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg disabled:opacity-50">ç¢ºèªå„²å­˜</button>
                    </div>
                </div>
            );
        };

        // æ–°å¢æ™¯é» Modal
        const AddSpotModal = ({ isOpen, onClose, dayIndex, dayDate, userLocation, onAdded }) => {
            const [name, setName] = useState('');
            const [time, setTime] = useState(() => {
                const now = new Date();
                return `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            });

            const handleSave = async () => {
                if (!name) return;
                await dbOps.addCustomSpot({
                    name, time, type: 'custom', desc: 'æ‰‹å‹•æ–°å¢æ™¯é»',
                    dayIndex, 
                    lat: userLocation?.lat, lng: userLocation?.lng,
                    isCustom: true
                });
                onAdded();
                onClose();
                setName('');
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center sm:items-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-md p-5 rounded-t-3xl sm:rounded-2xl modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-2">ğŸ“ æ–°å¢ä¸­é€”æ™¯é»</h3>
                        <p className="text-sm text-gray-500 mb-4 bg-gray-100 p-2 rounded-lg inline-block">
                            Day {dayIndex} Â· {dayDate}
                        </p>
                        <input type="time" value={time} onChange={e=>setTime(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-3 font-mono" />
                        <input type="text" placeholder="æ™¯é»åç¨± (å¦‚: è·¯é‚Šå±•æœ›å°)" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-gray-100 p-3 rounded-xl mb-4" autoFocus />
                        <p className="text-xs text-gray-400 mb-4"><Icon name="map-pin" size={12} className="inline"/> å°‡è‡ªå‹•è¨˜éŒ„ç•¶å‰ GPS ä½ç½®</p>
                        <button onClick={handleSave} className="w-full bg-[#e85a4f] text-white py-3 rounded-xl font-bold text-lg">æ–°å¢è‡³è¡Œç¨‹</button>
                    </div>
                </div>
            );
        };

        const LocationCard = ({ loc, userLocation, day, onExpense }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [photo, setPhoto] = useState(null);
            const [showNoteInput, setShowNoteInput] = useState(false);
            const [note, setNote] = useState('');
            
            useEffect(() => {
                setIsExpanded(false);
                const checkData = async () => {
                    const savedPhoto = await dbOps.getPhoto(`${day}_${loc.name}`);
                    setPhoto(savedPhoto || null);
                    const savedNote = await dbOps.getNote(`${day}_${loc.name}`);
                    setNote(savedNote || '');
                };
                checkData();
            }, [loc.name, day]);

            const handleCapture = (e) => {
                if (e.target.files?.[0]) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64 = e.target.result;
                        setPhoto(base64);
                        await dbOps.savePhoto(`${day}_${loc.name}`, base64);
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            const handleSaveNote = async () => {
                await dbOps.saveNote(`${day}_${loc.name}`, note);
                setShowNoteInput(false);
                // å¯ä»¥åŠ å€‹ç°¡å–®æç¤ºï¼Œæˆ–æ˜¯ä¸ç”¨
            };
            
            const distance = useMemo(() => {
                if (!userLocation || !loc.lat || !loc.lng) return null;
                return calculateDistance(userLocation.lat, userLocation.lng, loc.lat, loc.lng);
            }, [userLocation, loc]);

            return (
                <div className={`bg-white p-4 rounded-2xl card-shadow border relative overflow-hidden transition-all duration-300 ${loc.isCustom ? 'border-orange-200 bg-orange-50/30' : 'border-gray-100'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex items-center gap-2">
                            <div className={`p-1.5 rounded-lg ${loc.type === 'food' ? 'bg-orange-100 text-orange-500' : 'bg-gray-100 text-gray-500'}`}>
                                <Icon name={loc.type === 'food' ? 'utensils' : loc.type === 'shop' ? 'shopping-bag' : loc.type === 'transport' ? 'car' : 'map-pin'} size={16} />
                            </div>
                            <span className="font-mono text-lg font-bold text-gray-800">{loc.time}</span>
                        </div>
                        
                        <div className="flex gap-2">
                            <button onClick={() => setShowNoteInput(!showNoteInput)} className={`p-1.5 rounded-full border shadow-sm active:scale-90 flex items-center justify-center w-8 h-8 ${note ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                <Icon name="pencil" size={14} />
                            </button>
                            <button onClick={() => onExpense(loc.name)} className="bg-yellow-50 text-yellow-600 p-1.5 rounded-full border border-yellow-200 shadow-sm active:scale-90 flex items-center justify-center w-8 h-8">
                                <Icon name="wallet" size={16} />
                            </button>
                            <label className={`p-1.5 rounded-full cursor-pointer hover:bg-gray-100 active:scale-90 transition-transform flex items-center justify-center w-8 h-8 ${photo ? 'bg-[#e85a4f] text-white shadow-md' : 'bg-gray-50 text-gray-500'}`}>
                                <input type="file" accept="image/*" className="hidden" onChange={handleCapture} />
                                <Icon name="camera" size={16} />
                            </label>
                            {loc.link && <a href={loc.link} target="_blank" className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Icon name="navigation" size={12} /> å°èˆª</a>}
                        </div>
                    </div>
                    
                    <h3 className="text-xl font-bold text-gray-800 mb-1">{loc.name} {loc.isCustom && <span className="text-[10px] text-orange-500 bg-orange-100 px-1 rounded ml-1">æ‰‹å‹•</span>}</h3>
                    
                    {distance && <p className="text-xs text-blue-500 font-bold mb-1 flex items-center gap-1"><Icon name="navigation-2" size={10} /> è· {distance}</p>}
                    <p className="text-gray-500 text-sm mb-3">{loc.desc}</p>

                     {/* ç­†è¨˜è¼¸å…¥å€åŸŸ */}
                    {showNoteInput && (
                        <div className="mb-3 animate-fade-in">
                            <textarea 
                                value={note}
                                onChange={(e) => setNote(e.target.value)}
                                placeholder="å¯«é»ä»€éº¼..."
                                className="w-full p-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-100 outline-none mb-2"
                                rows="3"
                            />
                            <div className="flex justify-end gap-2">
                                {/* ä¿®æ­£ï¼šå–æ¶ˆæ™‚ï¼Œé‡æ–°è®€å–è³‡æ–™åº«çš„èˆŠç­†è¨˜ä¾†é‚„åŸç‹€æ…‹ */}
                                <button 
                                    onClick={async () => {
                                        setShowNoteInput(false);
                                        const savedNote = await dbOps.getNote(`${day}_${loc.name}`);
                                        setNote(savedNote || '');
                                    }} 
                                    className="text-xs text-gray-400 px-3 py-1"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button onClick={handleSaveNote} className="text-xs bg-blue-500 text-white px-3 py-1 rounded-md shadow-sm">å„²å­˜</button>
                            </div>
                        </div>
                    )}

                    {/* å·²å„²å­˜çš„ç­†è¨˜é¡¯ç¤º (æ–°å¢) - å¦‚æœæ²’åœ¨è¼¸å…¥æ¨¡å¼ä¸”æœ‰ç­†è¨˜æ™‚é¡¯ç¤º */}
                    {!showNoteInput && note && (
                        <div 
                            className="mb-3 p-3 bg-yellow-50/50 border border-yellow-100 rounded-lg text-sm text-gray-600 cursor-pointer hover:bg-yellow-50 transition-colors"
                            onClick={() => setShowNoteInput(true)} // é»æ“Šå¯å†æ¬¡ç·¨è¼¯
                        >
                            <div className="flex items-start gap-2">
                                <Icon name="sticky-note" size={14} className="text-yellow-400 mt-0.5 shrink-0" />
                                <span className="whitespace-pre-wrap">{note}</span>
                            </div>
                        </div>
                    )}


                    
                    {photo && (
                        <div className="mb-3 relative rounded-lg overflow-hidden border border-gray-200 animate-fade-in group">
                            <img src={photo} className="w-full h-32 object-cover" />
                            <div className="absolute bottom-0 right-0 bg-[#e85a4f] text-white text-[10px] px-2 py-1 rounded-tl-lg font-bold">å·²ç´€éŒ„</div>
                            
                            {/* æ–°å¢åˆªé™¤æŒ‰éˆ• */}
                            <button 
                                onClick={async (e) => {
                                    e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å¡ç‰‡å±•é–‹
                                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ')) {
                                        await dbOps.deletePhoto(`${day}_${loc.name}`);
                                        setPhoto(null);
                                    }
                                }}
                                className="absolute top-2 right-2 bg-black/50 text-white p-1.5 rounded-full hover:bg-red-500 transition-colors"
                            >
                                <Icon name="trash-2" size={14} />
                            </button>
                        </div>
                    )}
                    <div className="flex justify-between items-end">
                        <div className="flex flex-wrap gap-1">{loc.tags && loc.tags.map(tag => <Tag key={tag} text={tag} />)}</div>
                        {loc.details && <button onClick={() => setIsExpanded(!isExpanded)} className="text-gray-400 hover:text-[#e85a4f] flex items-center gap-1 text-xs font-medium p-1 transition-colors">{isExpanded ? 'æ”¶èµ·' : 'ä»‹ç´¹'} <Icon name={isExpanded ? "chevron-up" : "chevron-down"} size={14} /></button>}
                    </div>
                    {isExpanded && loc.details && <div className="mt-4 pt-4 border-t border-gray-100 animate-fade-in text-sm text-gray-600 leading-relaxed text-justify">{loc.details}</div>}
                </div>
            );
        };

        const TabItinerary = ({ tripData, activeDay, setActiveDay, userLocation, onExpense }) => {
            const [mergedLocations, setMergedLocations] = useState([]);
            const [isSpotModalOpen, setIsSpotModalOpen] = useState(false);

            const loadAndMerge = async () => {
                const staticLocs = tripData.find(t => t.day === activeDay)?.locations || [];
                const customSpots = await dbOps.getCustomSpots();
                const dayCustomSpots = customSpots.filter(s => s.dayIndex === activeDay);
                const all = [...staticLocs, ...dayCustomSpots].sort((a, b) => a.time.localeCompare(b.time));
                setMergedLocations(all);
            };

            useEffect(() => { loadAndMerge(); }, [activeDay]);

            const currentTrip = tripData.find(t => t.day === activeDay);

            return (
                <div className="pb-24">
                    <div className="relative h-64 w-full">
                        <img src={currentTrip.image} className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                        <div className="absolute bottom-4 left-5 right-5 text-white">
                            <div className="flex items-center gap-2 mb-1 opacity-90">
                                <span className="bg-white/20 backdrop-blur-sm px-2 py-0.5 rounded text-xs font-bold">{currentTrip.date}</span>
                                <span className="flex items-center text-xs"><Icon name="cloud-sun" size={14} className="mr-1"/> {currentTrip.weather}</span>
                            </div>
                            <h2 className="text-3xl font-bold">{currentTrip.title}</h2>
                        </div>
                    </div>

                    <div className="sticky top-0 z-30 bg-[#f8f5f2]/95 backdrop-blur-sm pt-4 pb-2 px-2 shadow-sm">
                        <div className="flex overflow-x-auto gap-3 scrollbar-hide px-2 pb-2">
                            {tripData.map((day) => (
                                <button key={day.day} onClick={() => setActiveDay(day.day)} className={`flex-shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl transition-all ${activeDay === day.day ? "bg-[#e85a4f] text-white shadow-lg scale-105" : "bg-white text-gray-400 border border-gray-100"}`}>
                                    <span className="text-[10px]">D{day.day}</span>
                                    <span className="text-lg font-bold">{day.date.split('/')[1].split(' ')[0]}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="px-5 mt-4 space-y-6">
                        {mergedLocations.map((loc, idx) => (
                            <LocationCard key={idx} loc={loc} userLocation={userLocation} day={currentTrip.day} onExpense={onExpense} />
                        ))}
                        {currentTrip.hotel && <div className="bg-[#2d3436] text-white p-5 rounded-2xl shadow-lg mt-8 mb-4"><h3 className="text-xl font-bold">{currentTrip.hotel.name}</h3></div>}
                    </div>

                    <button 
                        onClick={() => setIsSpotModalOpen(true)}
                        className="fixed bottom-24 right-5 bg-[#e85a4f] text-white p-4 rounded-full shadow-2xl active:scale-90 transition-transform z-40 border-4 border-[#f8f5f2]"
                    >
                        <Icon name="plus" size={28} />
                    </button>

                    <AddSpotModal 
                        isOpen={isSpotModalOpen} 
                        onClose={() => setIsSpotModalOpen(false)} 
                        dayIndex={activeDay}
                        dayDate={currentTrip.fullDate}
                        userLocation={userLocation}
                        onAdded={loadAndMerge} 
                    />
                </div>
            );
        };

        const TabBudget = () => {
            const [expenses, setExpenses] = useState([]);
            useEffect(() => {
                setExpenses(JSON.parse(localStorage.getItem('trip_expenses') || '[]'));
            }, []);

            const total = expenses.reduce((acc, curr) => acc + curr.amount, 0);

            return (
                <div className="px-5 pt-12 pb-24">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">æ¶ˆè²»çµ±è¨ˆ</h2>
                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white p-6 rounded-3xl shadow-lg mb-8 text-center">
                        <span className="text-white/80 text-sm font-medium">è¨˜å¸³ç¸½é¡</span>
                        <div className="text-4xl font-bold font-mono mt-1">Â¥{total.toLocaleString()}</div>
                    </div>
                    <div className="space-y-3">
                        {expenses.length === 0 && <div className="text-center text-gray-400 py-10">å°šç„¡ç´€éŒ„ï¼Œè«‹è‡³è¡Œç¨‹é é¢è¨˜å¸³</div>}
                        {expenses.map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm">
                                <div>
                                    <span className="font-bold text-gray-800 block">{item.name}</span>
                                    <span className="text-xs text-gray-400">{item.date}</span>
                                </div>
                                <span className="font-mono font-bold text-gray-800">Â¥{item.amount.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TabInfo = () => <div className="p-5 pt-12"><h2 className="text-2xl font-bold mb-4">åŠŸèƒ½é¸å–®</h2><button onClick={exportData} className="w-full bg-blue-500 text-white p-4 rounded-xl font-bold shadow-md">åŒ¯å‡ºå®Œæ•´éŠè¨˜å‚™ä»½</button></div>;

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [activeDay, setActiveDay] = useState(1);
            const [userLocation, setUserLocation] = useState(null);
            const [expenseModalInfo, setExpenseModalInfo] = useState({ isOpen: false, defaultName: '', defaultDate: '' });

            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }));
                }
            }, [activeTab, activeDay]);

            const currentTripDate = tripData.find(t => t.day === activeDay)?.fullDate;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#f8f5f2] relative shadow-2xl">
                    {activeTab === 'itinerary' && (
                        <TabItinerary 
                            tripData={tripData} 
                            activeDay={activeDay} 
                            setActiveDay={setActiveDay} 
                            userLocation={userLocation}
                            onExpense={(name) => setExpenseModalInfo({ isOpen: true, defaultName: name, defaultDate: currentTripDate })}
                        />
                    )}
                    {activeTab === 'info' && <TabInfo />}
                    {activeTab === 'budget' && <TabBudget />}

                    <ExpenseModal 
                        isOpen={expenseModalInfo.isOpen} 
                        defaultName={expenseModalInfo.defaultName}
                        defaultDate={expenseModalInfo.defaultDate}
                        onClose={() => setExpenseModalInfo({ ...expenseModalInfo, isOpen: false })}
                    />

                    <div className="fixed bottom-0 left-0 right-0 glass-nav z-50 max-w-md mx-auto">
                        <div className="flex justify-around items-center py-3">
                            <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="map" size={24} /><span className="text-[10px]">è¡Œç¨‹</span></button>
                            <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 ${activeTab === 'info' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="file-text" size={24} /><span className="text-[10px]">è³‡è¨Š</span></button>
                            <button onClick={() => setActiveTab('budget')} className={`flex flex-col items-center gap-1 ${activeTab === 'budget' ? 'text-[#e85a4f]' : 'text-gray-400'}`}><Icon name="wallet" size={24} /><span className="text-[10px]">çµ±è¨ˆ</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>








